<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge OS - çŸ¥è¯†åº“æ™ºèƒ½å·¥ä½œå° V8.1 (Refactored)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS ä¿æŒ V8.0 â€œæ˜Ÿäº‘â€é£æ ¼ï¼Œç¡®ä¿è§†è§‰ä¸€è‡´æ€§ */
        :root {
            --bg-universe: #0b0c15;
            --bg-sidebar: #12131f;
            --bg-card: #1c1d2e;
            --bg-card-hover: #232438;
            --border-color: rgba(112, 112, 155, 0.15);
            --brand-primary: #7059fb;
            --brand-cyan: #00f0ff;
            --brand-success: #00d2b6;
            --brand-warning: #ffb86c;
            --text-main: #ffffff;
            --text-secondary: #8f9bb3;
            --radius-lg: 12px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Noto Sans SC', sans-serif; background-color: var(--bg-universe); color: var(--text-main); height: 100vh; overflow: hidden; background-image: radial-gradient(circle at 15% 50%, rgba(112, 89, 251, 0.08), transparent 25%), radial-gradient(circle at 85% 30%, rgba(0, 240, 255, 0.05), transparent 25%); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }

        .app-container { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 260px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 24px 16px; z-index: 100; overflow: hidden; }
        .logo-area { font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 30px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .logo-dot { width: 8px; height: 8px; background: var(--brand-primary); border-radius: 50%; box-shadow: 0 0 8px var(--brand-primary); }
        .btn-import { width: 100%; padding: 12px; border: 1px dashed var(--brand-primary); background: rgba(112, 89, 251, 0.05); color: var(--brand-primary); border-radius: 8px; cursor: pointer; transition: 0.3s; text-align: center; margin-bottom: 30px; font-size: 14px; position: relative; }
        .btn-import:hover { background: rgba(112, 89, 251, 0.15); box-shadow: 0 0 12px rgba(112, 89, 251, 0.2); }
        .btn-import.drag-over { background: rgba(112, 89, 251, 0.25); border-color: var(--brand-primary); border-style: solid; box-shadow: 0 0 20px rgba(112, 89, 251, 0.4); }
        .search-box { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-main); font-size: 13px; margin-bottom: 16px; transition: all 0.2s; }
        .search-box:focus { outline: none; border-color: var(--brand-primary); background: rgba(112, 89, 251, 0.05); box-shadow: 0 0 8px rgba(112, 89, 251, 0.2); }
        .search-box::placeholder { color: var(--text-secondary); }
        .file-list-header { font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #sidebar-file-list { flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; }
        #sidebar-file-list::-webkit-scrollbar { width: 6px; }
        #sidebar-file-list::-webkit-scrollbar-track { background: transparent; }
        #sidebar-file-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        #sidebar-file-list::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        .file-item { padding: 12px 14px; border-radius: 8px; margin-bottom: 8px; transition: all 0.2s; border-left: 3px solid transparent; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .file-item:hover { background: rgba(255,255,255,0.03); }
        .file-item.active { background: rgba(112, 89, 251, 0.1); border-left-color: var(--brand-primary); }
        .file-item.hidden { display: none; }
        .file-item-content { flex: 1; cursor: pointer; min-width: 0; }
        .file-name { font-size: 14px; margin-bottom: 4px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 12px; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; }
        .status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; }
        .processing-spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(112, 89, 251, 0.3); border-top-color: var(--brand-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 4px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .page-controls { display: flex; align-items: center; gap: 8px; }
        .page-input { width: 60px; padding: 4px 8px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-main); font-size: 12px; text-align: center; }
        .page-input:focus { outline: none; border-color: var(--brand-primary); }
        .page-btn { padding: 4px 8px; background: rgba(112, 89, 251, 0.1); border: 1px solid var(--brand-primary); border-radius: 4px; color: var(--brand-primary); cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .page-btn:hover { background: rgba(112, 89, 251, 0.2); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #pdf-content { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #pdf-content img { transition: transform 0.1s; cursor: move; user-select: none; }
        #pdf-content img.zoomed { cursor: move; }
        #pdf-content img.dragging { cursor: grabbing; transition: none; }

        .main-workspace { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-header { height: 60px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; background: rgba(18, 19, 31, 0.8); backdrop-filter: blur(10px); }
        .doc-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 12px; }
        .status-badge { font-size: 12px; padding: 4px 10px; background: rgba(255, 184, 108, 0.1); color: var(--brand-warning); border: 1px solid rgba(255, 184, 108, 0.3); border-radius: 20px; }
        .last-update { font-size: 12px; color: var(--text-secondary); }

        .resizer { background: transparent; z-index: 50; transition: 0.2s; }
        .resizer-x { width: 5px; cursor: col-resize; border-left: 1px solid transparent; }
        .resizer-y { height: 5px; cursor: row-resize; border-top: 1px solid transparent; }
        .resizer:hover { border-color: var(--brand-primary); }

        .comparison-container { 
            height: 55%; 
            flex: 0 0 55%;
            display: flex; 
            background-color: var(--bg-universe); 
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
            position: relative;
        }
        .panel { 
            display: flex; 
            flex-direction: column; 
            background-color: var(--bg-universe); 
            border-right: 1px solid var(--border-color); 
            min-width: 0;
            min-height: 0;
            overflow: hidden;
            height: 100%;
            box-sizing: border-box;
        }
        .panel:first-child { 
            flex: 0 0 50%; 
            min-width: 0;
            max-width: 50%;
            width: 50%;
            box-sizing: border-box;
        }
        .panel:last-child { 
            border-right: none; 
            flex: 0 0 50%; 
            min-width: 0;
            max-width: 50%;
            width: 50%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .panel-header { height: 40px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(28, 29, 46, 0.5); border-bottom: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary); font-weight: 600; }
        .header-action { color: var(--brand-primary); cursor: pointer; }

        .panel-body { 
            flex: 1; 
            position: relative; 
            overflow: hidden; 
            padding: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: background-color 0.2s; 
            min-height: 0; 
        }
        .panel-body.scrollable { 
            overflow: auto; 
            align-items: flex-start; 
            justify-content: flex-start; 
        }
        .panel-body.highlighted { background-color: rgba(0, 240, 255, 0.08); } /* è·³è½¬é«˜äº®æ•ˆæœ */

        .pdf-image-mock { max-width: 100%; max-height: 100%; object-fit: contain; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .pdf-image-mock.zoomed { max-width: none; max-height: none; }

        .text-stream-content { 
            /* å³ä¾§ AI è§£ææ–‡æœ¬ä¸»å®¹å™¨ï¼šå§‹ç»ˆåœ¨å¯è§†åŒºåŸŸå†…æ»šåŠ¨æ˜¾ç¤ºï¼Œä¸å†ä¾èµ–æµè§ˆå™¨æ•´ä½“ç¼©æ”¾ */
            padding: 18px 22px;
            overflow-y: auto; 
            overflow-x: hidden;
            color: #d1d5db; 
            font-size: 14px;
            line-height: 1.8; 
            width: 100%;
            max-width: 100%;
            height: 100%;
            box-sizing: border-box;
            display: block;
            min-width: 0;
            min-height: 0;
            position: relative;
            background: radial-gradient(circle at top left, rgba(112, 89, 251, 0.06), transparent 55%);
        }
        
        /* è§£æåŒºåŸŸå†…éƒ¨ï¼šåªåšå¿…è¦çš„é˜²æº¢å‡ºå¤„ç†ï¼Œé¿å…å¤æ‚ contain/white-space å¯¼è‡´åœ¨éƒ¨åˆ†æµè§ˆå™¨éœ€è¦ç¼©æ”¾æ‰èƒ½çœ‹åˆ°å†…å®¹ */
        .text-stream-content * {
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .text-stream-content .markdown-content {
            max-width: 100%;
            width: 100%;
            min-width: 0;
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }
        .text-stream-content h1 {
            font-size: clamp(22px, 2.5vw, 30px);
        }
        .text-stream-content h2 {
            font-size: clamp(20px, 2.2vw, 26px);
        }
        .text-stream-content h3 { 
            color: var(--text-main); 
            margin-top: 0; 
            font-size: clamp(18px, 2vw, 24px); 
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            box-sizing: border-box;
        }
        .text-stream-content h4 {
            font-size: clamp(17px, 1.8vw, 22px);
        }
        .text-stream-content h5 {
            font-size: clamp(16px, 1.6vw, 20px);
        }
        .text-stream-content h6 {
            font-size: clamp(15px, 1.4vw, 18px);
        }
        .text-stream-content h1, .text-stream-content h2, .text-stream-content h3, 
        .text-stream-content h4, .text-stream-content h5, .text-stream-content h6 {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            box-sizing: border-box;
            margin: 0.5em 0;
            line-height: 1.4;
        }
        .text-stream-content p {
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-sizing: border-box;
            margin: 0.5em 0;
            line-height: 1.6;
            font-size: clamp(14px, 1.5vw, 18px);
        }
        .text-stream-content ul, .text-stream-content ol {
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-sizing: border-box;
            margin: 0.5em 0;
            padding-left: clamp(1em, 2vw, 1.5em);
            font-size: clamp(14px, 1.5vw, 18px);
        }
        .text-stream-content li {
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-sizing: border-box;
            margin: 0.25em 0;
            line-height: 1.6;
            font-size: clamp(14px, 1.5vw, 18px);
        }
        .text-stream-content div {
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-sizing: border-box;
            font-size: clamp(14px, 1.5vw, 18px);
        }
        .text-stream-content code {
            font-size: clamp(13px, 1.3vw, 16px);
        }
        .text-stream-content pre {
            font-size: clamp(13px, 1.3vw, 16px);
        }
        /* ç‰¹åˆ«å¤„ç† pre / codeï¼Œä¿è¯å¯è¯»åˆä¸æ’‘çˆ†å®¹å™¨ */
        .text-stream-content pre,
        .text-stream-content code {
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: anywhere;
            overflow-x: hidden;
            white-space: pre-wrap;
        }
        .highlight-text { color: var(--brand-cyan); border-bottom: 1px dashed var(--brand-cyan); padding-bottom: 1px; }

        /* å“åº”å¼å­—ä½“å¤§å°ä¼˜åŒ– - åŸºäºè§†å£å’Œå®¹å™¨å®½åº¦ */
        @media (max-width: 1200px) {
            .text-stream-content {
                font-size: clamp(13px, 1.4vw, 17px) !important;
            }
            .text-stream-content p,
            .text-stream-content li,
            .text-stream-content div {
                font-size: clamp(13px, 1.4vw, 17px) !important;
            }
            .text-stream-content h1 { font-size: clamp(20px, 2.3vw, 28px) !important; }
            .text-stream-content h2 { font-size: clamp(18px, 2.1vw, 24px) !important; }
            .text-stream-content h3 { font-size: clamp(16px, 1.9vw, 22px) !important; }
            .text-stream-content h4 { font-size: clamp(15px, 1.7vw, 20px) !important; }
            .text-stream-content h5 { font-size: clamp(14px, 1.6vw, 19px) !important; }
            .text-stream-content h6 { font-size: clamp(13px, 1.5vw, 17px) !important; }
        }
        
        @media (max-width: 900px) {
            .text-stream-content {
                font-size: clamp(12px, 1.3vw, 16px) !important;
            }
            .text-stream-content p,
            .text-stream-content li,
            .text-stream-content div {
                font-size: clamp(12px, 1.3vw, 16px) !important;
            }
            .text-stream-content h1 { font-size: clamp(18px, 2.1vw, 26px) !important; }
            .text-stream-content h2 { font-size: clamp(16px, 1.9vw, 22px) !important; }
            .text-stream-content h3 { font-size: clamp(15px, 1.8vw, 20px) !important; }
            .text-stream-content h4 { font-size: clamp(14px, 1.7vw, 19px) !important; }
            .text-stream-content h5 { font-size: clamp(13px, 1.6vw, 18px) !important; }
            .text-stream-content h6 { font-size: clamp(12px, 1.5vw, 16px) !important; }
        }
        
        @media (min-width: 1600px) {
            .text-stream-content {
                font-size: clamp(15px, 1.6vw, 20px) !important;
            }
            .text-stream-content p,
            .text-stream-content li,
            .text-stream-content div {
                font-size: clamp(15px, 1.6vw, 20px) !important;
            }
            .text-stream-content h1 { font-size: clamp(24px, 2.6vw, 32px) !important; }
            .text-stream-content h2 { font-size: clamp(22px, 2.4vw, 28px) !important; }
            .text-stream-content h3 { font-size: clamp(20px, 2.2vw, 26px) !important; }
            .text-stream-content h4 { font-size: clamp(19px, 2.0vw, 24px) !important; }
            .text-stream-content h5 { font-size: clamp(18px, 1.9vw, 22px) !important; }
            .text-stream-content h6 { font-size: clamp(17px, 1.8vw, 20px) !important; }
        }

        .chunks-container {
            flex-grow: 1;
            background-color: rgba(18, 19, 31, 0.6);
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--border-color);
            /* ğŸš€ ä¼˜åŒ– 1: è§£é™¤æ‹–æ‹½é™åˆ¶ï¼Œå…è®¸è¢«å‹ç¼©åˆ°æœ€å°é«˜åº¦ */
            min-height: 0;
        }
        .chunks-header { padding: 15px 24px; display: flex; justify-content: space-between; align-items: center; }
        .section-title { font-size: 14px; font-weight: 700; color: var(--text-secondary); }
        .chunks-header-actions { display: flex; gap: 10px; align-items: center; }
        .btn-create { background: linear-gradient(135deg, var(--brand-primary) 0%, #5a47d4 100%); color: #fff; border: none; padding: 7px 20px; border-radius: 999px; font-size: 12px; cursor: pointer; box-shadow: 0 4px 14px rgba(112, 89, 251, 0.4); transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; font-weight: 500; letter-spacing: 0.3px; }
        .btn-create.secondary { background: linear-gradient(135deg, rgba(0, 240, 255, 0.12) 0%, rgba(112, 89, 251, 0.12) 100%); color: var(--brand-cyan); border: 1px solid rgba(0, 240, 255, 0.3); box-shadow: 0 2px 10px rgba(0, 240, 255, 0.2); }
        .btn-create.secondary:hover { background: linear-gradient(135deg, rgba(0, 240, 255, 0.2) 0%, rgba(112, 89, 251, 0.2) 100%); color: #fff; border-color: var(--brand-cyan); box-shadow: 0 4px 16px rgba(0, 240, 255, 0.4); transform: translateY(-1px); }
        .btn-create:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; filter: grayscale(0.6); }
        .btn-create:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(112, 89, 251, 0.6); transform: translateY(-2px); }

        .chunks-list { flex: 1; padding: 0 24px 30px 24px; overflow-y: auto; }
        .chunk-card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; position: relative; transition: all 0.3s; }
        .chunk-card:hover { border-color: var(--brand-primary); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); background-color: var(--bg-card-hover); }
        .chunk-id { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; display: block; }
        .chunk-content { font-size: 14px; color: var(--text-main); margin-bottom: 20px; line-height: 1.6; }

        .chunk-footer { display: flex; align-items: center; justify-content: space-between; }
        .tags-group { display: flex; gap: 8px; align-items: center; }
        .tag { background: rgba(255, 255, 255, 0.05); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: var(--text-secondary); }

        .source-btn { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: rgba(112, 89, 251, 0.1); border: 1px solid rgba(112, 89, 251, 0.3); color: var(--brand-primary); border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .source-btn:hover { background: var(--brand-primary); color: #fff; }

        .actions-group { display: flex; gap: 12px; }
        .action-link { font-size: 12px; cursor: pointer; color: var(--text-secondary); transition: 0.2s; background: transparent; border: none; display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; }
        .action-link:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .action-link.delete { color: var(--text-secondary); font-size: 14px; padding: 6px 8px; }
        .action-link.delete:hover { color: #ff4757; background: rgba(255, 71, 87, 0.15); }

        .chunk-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .chunk-status-badge.confirmed {
            background: rgba(0, 210, 182, 0.12);
            color: var(--brand-success);
            border-color: rgba(0, 210, 182, 0.4);
        }

        .btn-confirm { background: rgba(0, 210, 182, 0.1); color: var(--brand-success); border: 1px solid rgba(0, 210, 182, 0.3); padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .btn-confirm:hover { background: var(--brand-success); color: #000; }
        .btn-confirm.disabled,
        .btn-confirm:disabled {
            opacity: 0.6;
            cursor: default;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* çŸ¥è¯†åˆ‡ç‰‡ç¼–è¾‘å¼¹çª—æ ·å¼ - æ˜Ÿäº‘é£æ ¼ */
        .chunk-modal-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 50% 50%, rgba(112, 89, 251, 0.12), rgba(0, 0, 0, 0.8));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            animation: fadeIn 0.25s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .chunk-modal {
            width: min(760px, 92vw);
            max-height: 85vh;
            background: linear-gradient(145deg, #1c1d2e 0%, #12131f 100%);
            border-radius: 18px;
            border: 1px solid rgba(112, 89, 251, 0.3);
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.9),
                0 0 0 1px rgba(112, 89, 251, 0.15) inset,
                0 10px 40px rgba(112, 89, 251, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(40px) scale(0.94);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .chunk-modal-header {
            padding: 20px 26px;
            border-bottom: 1px solid rgba(112, 89, 251, 0.18);
            background: rgba(112, 89, 251, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chunk-modal-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-main);
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chunk-modal-title::before {
            content: 'âœ¨';
            font-size: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        .chunk-modal-close {
            border: none;
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 22px;
            line-height: 1;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
        }
        .chunk-modal-close:hover {
            background: rgba(255, 71, 87, 0.18);
            color: #ff4757;
            transform: rotate(90deg) scale(1.1);
        }
        .chunk-modal-body {
            padding: 22px 26px 18px 26px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            overflow-y: auto;
            flex: 1;
        }
        .chunk-modal-body > div {
            display: flex;
            flex-direction: column;
        }
        .chunk-modal-body label {
            font-size: 13px;
            color: var(--brand-cyan);
            font-weight: 500;
            display: block;
            margin-bottom: 10px;
            letter-spacing: 0.4px;
        }
        #chunk-modal-content {
            width: 100%;
            min-height: 150px;
            max-height: 320px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            border: 1px solid rgba(112, 89, 251, 0.25);
            color: var(--text-main);
            padding: 14px 16px;
            font-size: 14px;
            line-height: 1.7;
            resize: vertical;
            transition: all 0.25s ease;
            font-family: 'Noto Sans SC', sans-serif;
        }
        #chunk-modal-content:focus,
        #chunk-modal-tags:focus,
        #chunk-modal-page:focus {
            outline: none;
            border-color: var(--brand-primary);
            background: rgba(112, 89, 251, 0.1);
            box-shadow: 0 0 0 4px rgba(112, 89, 251, 0.15);
        }
        #chunk-modal-tags,
        #chunk-modal-page {
            width: 100%;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            border: 1px solid rgba(112, 89, 251, 0.25);
            color: var(--text-main);
            padding: 11px 14px;
            font-size: 14px;
            transition: all 0.25s ease;
        }
        .chunk-modal-footer {
            padding: 16px 26px 20px 26px;
            border-top: 1px solid rgba(112, 89, 251, 0.18);
            background: rgba(0, 0, 0, 0.25);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .chunk-modal-btn {
            padding: 9px 24px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.25s ease;
            letter-spacing: 0.4px;
        }
        .chunk-modal-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        }
        .chunk-modal-btn.primary {
            background: linear-gradient(135deg, var(--brand-primary) 0%, #5a47d4 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(112, 89, 251, 0.45);
        }
        .chunk-modal-btn.primary:hover {
            background: linear-gradient(135deg, var(--brand-cyan) 0%, var(--brand-primary) 100%);
            box-shadow: 0 8px 24px rgba(0, 240, 255, 0.5);
            transform: translateY(-3px);
        }
    </style>
</head>
<body>

    <div class="app-container">

        <aside class="sidebar" id="sidebar">
            <div class="logo-area"><div class="logo-dot"></div>Sandbox OS</div>
            <div class="btn-import" id="import-zone" onclick="document.getElementById('file-input').click()">
                + å¯¼å…¥æ–°æ–‡æ¡£<br>
                <span style="font-size: 11px; opacity: 0.7;">æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</span>
            </div>
            <input type="file" id="file-input" style="display: none;" multiple accept=".pdf,.doc,.docx,.xlsx,.xls,.txt,.md,.json">
            <input type="text" id="file-search" class="search-box" placeholder="ğŸ” æœç´¢æ–‡æ¡£..." autocomplete="off">
            <div class="file-list-header">
                <span>çŸ¥è¯†æºåˆ—è¡¨ (<span id="file-count">0</span>)</span>
                <span id="search-result-count" style="font-size: 11px; color: var(--brand-primary); display: none;"></span>
            </div>
            <div id="sidebar-file-list"></div>
        </aside>

        <div class="resizer resizer-x" id="resizer-sidebar"></div>

        <main class="main-workspace">
            <header class="top-header">
                <div class="doc-title" id="doc-title-display"></div>
                <div class="last-update">æœ€åæ›´æ–°: 10åˆ†é’Ÿå‰</div>
            </header>

            <section class="comparison-container" id="comparison-area">

                <div class="panel">
                    <div class="panel-header">
                        <span>åŸæ–‡æ¡£è§†å›¾ (PDF)</span>
                        <div class="page-controls" id="page-controls" style="display: none;">
                            <button class="page-btn" id="page-prev" onclick="KnowledgeOS.changePage(-1)">â—€</button>
                            <input type="number" class="page-input" id="page-input" min="1" value="1" onchange="KnowledgeOS.goToPage(parseInt(this.value))">
                            <span style="color: var(--text-secondary); font-size: 12px;">/ <span id="page-total">0</span></span>
                            <button class="page-btn" id="page-next" onclick="KnowledgeOS.changePage(1)">â–¶</button>
                        </div>
                    </div>
                    <div class="panel-body" id="pdf-wrapper">
                        <div class="pdf-image-mock" id="pdf-content"></div>
                    </div>
                </div>

                <div class="resizer resizer-x" id="resizer-panel"></div>

                <div class="panel">
                    <div class="panel-header">
                        <span>è§£ææ–‡æœ¬æµ (AI æ¸…æ´—)</span>
                        <span style="color: var(--brand-cyan)">â— å·²å®Œæˆæ¸…æ´—</span>
                    </div>
                    <!-- å³ä¾§è§£æç»“æœä½¿ç”¨ç‹¬ç«‹å¯æ»šåŠ¨å®¹å™¨ï¼Œé¿å…æ•´ä½“é¡µé¢ç¼©æ”¾æ‰èƒ½çœ‹åˆ°å†…å®¹ -->
                    <div class="panel-body scrollable">
                    <div class="text-stream-content" id="parsed-text-content"></div>
                    </div>
                </div>
            </section>

            <div class="resizer resizer-y" id="resizer-horizontal"></div>

            <section class="chunks-container">
                <div class="chunks-header">
                    <span class="section-title" id="chunks-section-title">çŸ¥è¯†åˆ‡ç‰‡åˆ—è¡¨ (å…± 0 æ¡)</span>
                    <div class="chunks-header-actions">
                        <button class="btn-create secondary" id="btn-create-manual">âœ‚ åˆ›å»ºæ–°åˆ‡ç‰‡</button>
                        <button class="btn-create" id="btn-auto-chunk">âœ¨ è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åº“</button>
                    </div>
                </div>
                <div class="chunks-list" id="chunks-list"></div>
            </section>
        </main>
    </div>

    <!-- çŸ¥è¯†åˆ‡ç‰‡ç¼–è¾‘ / åˆ›å»ºå¼¹çª— -->
    <div class="chunk-modal-overlay" id="chunk-modal-overlay">
        <div class="chunk-modal">
            <div class="chunk-modal-header">
                <span class="chunk-modal-title" id="chunk-modal-title">ç¼–è¾‘çŸ¥è¯†åˆ‡ç‰‡</span>
                <button class="chunk-modal-close" id="chunk-modal-close-btn">Ã—</button>
            </div>
            <div class="chunk-modal-body">
                <div>
                    <label for="chunk-modal-content">åˆ‡ç‰‡å†…å®¹</label>
                    <textarea id="chunk-modal-content" placeholder="åœ¨è¿™é‡Œç¼–è¾‘æˆ–è¾“å…¥çŸ¥è¯†åˆ‡ç‰‡å†…å®¹"></textarea>
                </div>
                <div>
                    <label for="chunk-modal-tags">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå¤‡å­•, æ—¶é—´è¡¨ï¼‰</label>
                    <input id="chunk-modal-tags" type="text" placeholder="å¯é€‰ï¼Œä½¿ç”¨é€—å·æˆ–é¡¿å·åˆ†éš”å¤šä¸ªæ ‡ç­¾">
                </div>
                <div>
                    <label for="chunk-modal-page">æ¥æºé¡µç </label>
                    <input id="chunk-modal-page" type="number" min="1" value="1">
                </div>
            </div>
            <div class="chunk-modal-footer">
                <button class="chunk-modal-btn" id="chunk-modal-cancel-btn">å–æ¶ˆ</button>
                <button class="chunk-modal-btn primary" id="chunk-modal-save-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // =========================================================
        //                 KNOWLEDGE OS API (V8.1)
        // =========================================================
        const KnowledgeOS = {
            // ------------------ æ¥å£é…ç½® ------------------
            API_BASE: `${window.location.protocol}//${window.location.host}`,
            
            config: {
                activeFileId: null, // å½“å‰æ´»è·ƒæ–‡ä»¶ ID
                files: [],
                chunks: [],
                searchKeyword: '', // æœç´¢å…³é”®è¯
                currentPage: 1, // å½“å‰é¡µç 
                totalPages: 0, // æ€»é¡µæ•°
                imageScale: 1.0, // å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹
                imageOffsetX: 0, // å›¾ç‰‡Xåç§»
                imageOffsetY: 0, // å›¾ç‰‡Yåç§»
                isDragging: false, // æ˜¯å¦æ­£åœ¨æ‹–æ‹½
                dragStartX: 0, // æ‹–æ‹½èµ·å§‹X
                dragStartY: 0, // æ‹–æ‹½èµ·å§‹Y
                isAutoChunking: false // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åˆ‡ç‰‡
            },

            // ------------------ æ¸²æŸ“æ¨¡å— ------------------

            /** æ¸²æŸ“å·¦ä¾§æ–‡ä»¶åˆ—è¡¨ */
            renderSidebar: function() {
                const list = document.getElementById('sidebar-file-list');
                const searchKeyword = this.config.searchKeyword.toLowerCase().trim();
                
                // è¿‡æ»¤æ–‡ä»¶åˆ—è¡¨
                const filteredFiles = searchKeyword 
                    ? this.config.files.filter(file => file.name.toLowerCase().includes(searchKeyword))
                    : this.config.files;
                
                document.getElementById('file-count').textContent = this.config.files.length;
                
                // æ˜¾ç¤ºæœç´¢ç»“æœæ•°é‡
                const searchResultCount = document.getElementById('search-result-count');
                if (searchKeyword && filteredFiles.length !== this.config.files.length) {
                    searchResultCount.textContent = `æ‰¾åˆ° ${filteredFiles.length} ä¸ª`;
                    searchResultCount.style.display = 'inline';
                } else {
                    searchResultCount.style.display = 'none';
                }
                
                if (this.config.files.length === 0) {
                    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">æš‚æ— æ–‡æ¡£ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ </div>';
                    return;
                }
                
                if (filteredFiles.length === 0 && searchKeyword) {
                    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡æ¡£</div>';
                    return;
                }
                
                list.innerHTML = this.config.files.map(file => {
                    const isVisible = !searchKeyword || file.name.toLowerCase().includes(searchKeyword);
                    const isActive = file.id === this.config.activeFileId;
                    return `
                    <div class="file-item ${isActive ? 'active' : ''} ${!isVisible ? 'hidden' : ''}">
                        <div class="file-item-content" onclick="KnowledgeOS.setActiveFile('${file.id}')">
                            <span class="file-name">${this.highlightSearchKeyword(file.name, searchKeyword)}</span>
                        <div class="file-meta">
                                <span style="color: ${file.status_color || 'var(--text-secondary)'}; display: flex; align-items: center;">
                                    ${file.status === 'processing' ? '<span class="processing-spinner"></span>' : `<span class="status-dot" style="background:${file.status_color || 'var(--text-secondary)'}"></span>`}
                                    ${this.getStatusText(file.status)}
                            </span>
                            <span>${file.chunks_count || 0} åˆ‡ç‰‡</span>
                        </div>
                    </div>
                        <button class="action-link delete" data-doc-id="${file.id}" data-doc-name="${file.name.replace(/"/g, '&quot;')}" title="åˆ é™¤æ–‡æ¡£" style="flex-shrink: 0;">ğŸ—‘</button>
                    </div>
                `;
                }).join('');
            },
            
            /** é«˜äº®æœç´¢å…³é”®è¯ */
            highlightSearchKeyword: function(text, keyword) {
                if (!keyword) return text;
                const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<mark style="background: rgba(112, 89, 251, 0.3); color: var(--brand-primary); padding: 0 2px; border-radius: 2px;">$1</mark>');
            },
            
            /** è·å–çŠ¶æ€æ–‡æœ¬ */
            getStatusText: function(status) {
                const statusMap = {
                    'pending': 'å¾…å®¡æ ¸',
                    'processing': 'å¤„ç†ä¸­',
                    'completed': 'å·²å…¥åº“',
                    'archived': 'å·²å½’æ¡£',
                    'failed': 'å¤±è´¥'
                };
                return statusMap[status] || status;
            },
            
            /** åŠ è½½æ–‡æ¡£åˆ—è¡¨ */
            loadDocuments: async function() {
                try {
                    // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    const url = `${this.API_BASE}/api/rag/documents?t=${Date.now()}`;
                    console.log('åŠ è½½æ–‡æ¡£åˆ—è¡¨:', url);
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    const data = await response.json();
                    console.log('æ–‡æ¡£åˆ—è¡¨å“åº”:', data);
                    if (data.success) {
                        this.config.files = data.documents;
                        console.log(`åŠ è½½åˆ° ${this.config.files.length} ä¸ªæ–‡æ¡£`);
                        this.renderSidebar();
                        // å¦‚æœå½“å‰æ´»è·ƒæ–‡ä»¶å·²è¢«åˆ é™¤ï¼Œæ¸…ç©ºæ´»è·ƒçŠ¶æ€
                        if (this.config.activeFileId && !this.config.files.find(f => f.id === this.config.activeFileId)) {
                            this.config.activeFileId = null;
                            document.getElementById('doc-title-display').innerHTML = '';
                            this.config.chunks = [];
                            this.renderChunks();
                            this.renderPDFAndParsedText(1);
                        }
                        if (this.config.files.length > 0 && !this.config.activeFileId) {
                            this.setActiveFile(this.config.files[0].id);
                        }
                    } else {
                        console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', data.error);
                    }
                } catch (error) {
                    console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
                }
            },
            
            /** ä¸Šä¼ å•ä¸ªæ–‡æ¡£ */
            uploadDocument: async function(file) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch(`${this.API_BASE}/api/rag/documents/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        // ç«‹å³åˆ·æ–°æ–‡æ¡£åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ–°ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆçŠ¶æ€ä¸º processingï¼‰
                        await this.loadDocuments();
                        // å¯åŠ¨åå°å¤„ç†çŠ¶æ€è½®è¯¢ï¼ˆæ‰€æœ‰æ”¯æŒè§£æçš„æ–‡ä»¶ç±»å‹ï¼‰
                        const ext = file.name.toLowerCase().split('.').pop();
                        if (['pdf', 'doc', 'docx', 'txt', 'md', 'json', 'xlsx', 'xls'].includes(ext)) {
                            this.pollDocumentStatus(data.document.id);
                        }
                        return { success: true, filename: file.name, document: data.document };
                    } else {
                        return { success: false, filename: file.name, error: data.error || 'æœªçŸ¥é”™è¯¯' };
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    return { success: false, filename: file.name, error: error.message };
                }
            },
            
            /** è½®è¯¢æ–‡æ¡£å¤„ç†çŠ¶æ€ */
            pollDocumentStatus: function(documentId) {
                const maxAttempts = 120; // æœ€å¤šè½®è¯¢120æ¬¡ï¼ˆ10åˆ†é’Ÿï¼‰
                let attempts = 0;
                let hasRefreshed = false; // è®°å½•æ˜¯å¦å·²ç»åˆ·æ–°è¿‡
                
                const poll = async () => {
                    if (attempts >= maxAttempts) {
                        console.log(`[è½®è¯¢] æ–‡æ¡£ ${documentId} å¤„ç†è¶…æ—¶`);
                        return;
                    }
                    
                    try {
                        // æ¯æ¬¡è½®è¯¢éƒ½æ£€æŸ¥è§£ææ–‡æœ¬æ˜¯å¦å·²å­˜åœ¨ï¼ˆå³ä½¿çŠ¶æ€è¿˜æ˜¯ processingï¼‰
                        if (this.config.activeFileId === documentId && !hasRefreshed) {
                            try {
                                const activeFile = this.config.files.find(f => f.id === documentId);
                                if (activeFile) {
                                    // æ ¹æ®æ–‡ä»¶ç±»å‹ç¡®å®šè¦æ£€æŸ¥çš„é¡µç 
                                    const pageToCheck = activeFile.file_type === 'pdf' ? (this.config.currentPage || 1) : '';
                                    const parsedUrl = `${this.API_BASE}/api/rag/documents/${documentId}/parsed-text?page=${pageToCheck}`;
                                    const parsedResponse = await fetch(parsedUrl);
                                    const parsedData = await parsedResponse.json();
                                    
                                    if (parsedData.success && parsedData.content) {
                                        console.log('[è½®è¯¢] âœ… æ£€æµ‹åˆ°è§£ææ–‡æœ¬å·²å­˜åœ¨ï¼Œç«‹å³åˆ·æ–°æ•´ä¸ªè§†å›¾');
                                        hasRefreshed = true;
                                        // å…ˆæ›´æ–°æ–‡ä»¶åˆ—è¡¨ï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥
                                        await this.loadDocuments();
                                        // ç«‹å³åˆ·æ–°æ•´ä¸ªè§†å›¾ï¼ˆåŒ…æ‹¬PDFå’Œè§£ææ–‡æœ¬ï¼‰
                                        await this.renderPDFAndParsedText(this.config.currentPage || 1);
                                        // ç»§ç»­è½®è¯¢ä»¥æ›´æ–°çŠ¶æ€
                                    }
                                }
                            } catch (e) {
                                // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ­£å¸¸è½®è¯¢
                                console.error('[è½®è¯¢] æ£€æŸ¥è§£ææ–‡æœ¬å¤±è´¥:', e);
                            }
                        }
                        
                        const response = await fetch(`${this.API_BASE}/api/rag/documents?t=${Date.now()}`);
                        const data = await response.json();
                        if (data.success) {
                            const doc = data.documents.find(d => d.id === documentId);
                            if (doc) {
                                // æ›´æ–°æ–‡ä»¶çŠ¶æ€
                                const fileIndex = this.config.files.findIndex(f => f.id === documentId);
                                if (fileIndex !== -1) {
                                    const oldStatus = this.config.files[fileIndex].status;
                                    this.config.files[fileIndex] = doc;
                                    this.renderSidebar();
                                    
                                    // å¦‚æœæ–‡æ¡£å·²å®Œæˆå¤„ç†ï¼Œåœæ­¢è½®è¯¢å¹¶åˆ·æ–°ç•Œé¢
                                    if (doc.status === 'completed' || doc.status === 'failed') {
                                        console.log(`[è½®è¯¢] æ–‡æ¡£ ${documentId} å¤„ç†å®Œæˆï¼ŒçŠ¶æ€: ${doc.status}`);
                                        
                                        // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªæ–‡æ¡£ï¼Œè‡ªåŠ¨åˆ·æ–°æ•´ä¸ªè§†å›¾
                                        if (this.config.activeFileId === documentId) {
                                            console.log('[è½®è¯¢] æ–‡æ¡£å¤„ç†å®Œæˆï¼Œåˆ·æ–°æ•´ä¸ªè§†å›¾');
                                            await this.renderPDFAndParsedText(this.config.currentPage || 1);
                                        }
                                        
                                        // é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨ä»¥è·å–æœ€æ–°çŠ¶æ€
                                        await this.loadDocuments();
                                        return;
                                    }
                                    
                                    // å¦‚æœçŠ¶æ€ä» processing å˜ä¸ºå…¶ä»–çŠ¶æ€ï¼Œä¹Ÿåˆ·æ–°
                                    if (oldStatus === 'processing' && doc.status !== 'processing') {
                                        if (this.config.activeFileId === documentId) {
                                            console.log('[è½®è¯¢] çŠ¶æ€å˜åŒ–ï¼Œåˆ·æ–°è§†å›¾');
                                            await this.renderPDFAndParsedText(this.config.currentPage || 1);
                                        }
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('[è½®è¯¢] è·å–æ–‡æ¡£çŠ¶æ€å¤±è´¥:', error);
                    }
                    
                    attempts++;
                    // æ¯1ç§’è½®è¯¢ä¸€æ¬¡ï¼ˆåŠ å¿«å“åº”é€Ÿåº¦ï¼Œè§£æå®Œæˆåç«‹å³æ£€æµ‹ï¼‰
                    setTimeout(poll, 1000);
                };
                
                poll();
            },
            
            /** æ‰¹é‡ä¸Šä¼ æ–‡æ¡£ */
            uploadDocuments: async function(files) {
                if (!files || files.length === 0) return;
                
                const results = [];
                const total = files.length;
                let successCount = 0;
                let failCount = 0;
                
                // é€ä¸ªä¸Šä¼ æ–‡ä»¶
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const result = await this.uploadDocument(file);
                    results.push(result);
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                }
                
                // é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨
                await this.loadDocuments();
                
                // æ˜¾ç¤ºæ‰¹é‡ä¸Šä¼ ç»“æœ
                if (successCount === total) {
                    alert(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡æ¡£`);
                } else if (successCount > 0) {
                    const failFiles = results.filter(r => !r.success).map(r => r.filename).join('\n');
                    alert(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡æ¡£\nå¤±è´¥ ${failCount} ä¸ªæ–‡æ¡£ï¼š\n${failFiles}`);
                } else {
                    const failFiles = results.filter(r => !r.success).map(r => `${r.filename}: ${r.error}`).join('\n');
                    alert(`ä¸Šä¼ å¤±è´¥ï¼š\n${failFiles}`);
                }
            },
            
            /** åˆ é™¤æ–‡æ¡£ */
            deleteDocument: async function(documentId, documentName) {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ "${documentName}" å—ï¼Ÿ\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å…³çš„æ‰€æœ‰åˆ‡ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`)) {
                    return;
                }
                
                try {
                    console.log(`æ­£åœ¨åˆ é™¤æ–‡æ¡£: ${documentId}`);
                    const url = `${this.API_BASE}/api/rag/documents/${documentId}`;
                    console.log(`åˆ é™¤è¯·æ±‚ URL: ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log(`åˆ é™¤å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('åˆ é™¤å“åº”é”™è¯¯:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('åˆ é™¤å“åº”æ•°æ®:', data);
                    
                    if (data.success) {
                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ´»è·ƒæ–‡ä»¶ï¼Œæ¸…ç©ºæ´»è·ƒçŠ¶æ€
                        if (this.config.activeFileId === documentId) {
                            this.config.activeFileId = null;
                            document.getElementById('doc-title-display').innerHTML = '';
                            this.config.chunks = [];
                            this.renderChunks();
                            this.renderPDFAndParsedText(1);
                        }
                        // é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨
                        await this.loadDocuments();
                        alert('æ–‡æ¡£åˆ é™¤æˆåŠŸ');
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            },

            /** æ¸²æŸ“çŸ¥è¯†åˆ‡ç‰‡åˆ—è¡¨ */
            renderChunks: function() {
                const list = document.getElementById('chunks-list');
                document.getElementById('chunks-section-title').innerText = `çŸ¥è¯†åˆ‡ç‰‡åˆ—è¡¨ (å…± ${this.config.chunks.length} æ¡)`;

                if (this.config.chunks.length === 0) {
                    list.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">æš‚æ— çŸ¥è¯†åˆ‡ç‰‡ï¼Œç‚¹å‡»å³ä¸Šè§’æŒ‰é’®å¯ç”¨å¤§æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆã€‚</div>';
                    return;
                }

                list.innerHTML = this.config.chunks.map(chunk => `
                    <div class="chunk-card">
                        <span class="chunk-id">
                            ID: ${chunk.id}
                            <span class="chunk-status-badge ${chunk.status === 'confirmed' ? 'confirmed' : ''}">
                                ${chunk.status === 'confirmed' ? 'å·²å…¥åº“' : 'å¾…å®¡æ ¸'}
                            </span>
                        </span>
                        <div class="chunk-content">${chunk.content}</div>
                        <div class="chunk-footer">
                            <div class="tags-group">
                                ${(chunk.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                                ${chunk.source_page ? `<div class="source-btn" onclick="KnowledgeOS.jumpToPage(${chunk.source_page})">ğŸ“„ æ¥æº: ç¬¬ ${chunk.source_page} é¡µ</div>` : ''}
                            </div>
                            <div class="actions-group">
                                <button class="action-link delete" data-chunk-id="${chunk.id}">ğŸ—‘ åˆ é™¤</button>
                                <button class="action-link edit" data-chunk-id="${chunk.id}">âœï¸ ä¿®æ”¹</button>
                                <button class="btn-confirm ${chunk.status === 'confirmed' ? 'disabled' : ''}" data-chunk-id="${chunk.id}" ${chunk.status === 'confirmed' ? 'disabled' : ''}>
                                    ${chunk.status === 'confirmed' ? 'å·²å…¥åº“' : 'âœ” ç¡®è®¤å…¥åº“'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            /** åŠ è½½å½“å‰æ–‡æ¡£çš„çŸ¥è¯†åˆ‡ç‰‡ */
            loadChunksForActiveDocument: async function() {
                if (!this.config.activeFileId) {
                    this.config.chunks = [];
                    this.renderChunks();
                    return;
                }
                try {
                    const url = `${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/chunks`;
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.success) {
                        this.config.chunks = data.chunks || [];
                        this.renderChunks();
                    } else {
                        console.error('åŠ è½½çŸ¥è¯†åˆ‡ç‰‡å¤±è´¥:', data.error);
                    }
                } catch (e) {
                    console.error('åŠ è½½çŸ¥è¯†åˆ‡ç‰‡å¤±è´¥:', e);
                }
            },

            /** åŠ è½½è§£ææ–‡æœ¬ï¼ˆMarkdownï¼‰ */
            loadParsedText: async function(page) {
                const parsedTextEl = document.getElementById('parsed-text-content');
                if (!this.config.activeFileId) {
                    parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">è¯·é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£</div>';
                    return;
                }
                
                const activeFile = this.config.files.find(f => f.id === this.config.activeFileId);
                if (!activeFile) {
                    parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">æ–‡æ¡£ä¸å­˜åœ¨</div>';
                    return;
                }
                
                // å¦‚æœæ–‡æ¡£æ­£åœ¨å¤„ç†ä¸­ï¼Œå…ˆå°è¯•åŠ è½½è§£ææ–‡æœ¬ï¼ˆå¯èƒ½å·²ç»è§£æå®Œæˆä½†çŠ¶æ€è¿˜æ²¡æ›´æ–°ï¼‰
                if (activeFile.status === 'processing') {
                    // å…ˆå°è¯•åŠ è½½è§£ææ–‡æœ¬ï¼Œå¦‚æœå­˜åœ¨å°±æ˜¾ç¤ºï¼Œä¸å­˜åœ¨æ‰æ˜¾ç¤ºå¤„ç†çŠ¶æ€
                    try {
                        const pageToCheck = activeFile.file_type === 'pdf' ? (page || 1) : '';
                        const url = `${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/parsed-text?page=${pageToCheck}`;
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data.success && data.content) {
                            // è§£ææ–‡æœ¬å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤ºï¼ˆå³ä½¿çŠ¶æ€è¿˜æ˜¯ processingï¼‰
                            console.log('[loadParsedText] æ£€æµ‹åˆ°è§£ææ–‡æœ¬å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º');
                            this.renderMarkdown(parsedTextEl, data.content);
                            return;
                        }
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ˜¾ç¤ºå¤„ç†çŠ¶æ€
                        console.error('[loadParsedText] æ£€æŸ¥è§£ææ–‡æœ¬å¤±è´¥:', e);
                    }
                    
                    // è§£ææ–‡æœ¬ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºå¤„ç†çŠ¶æ€
                    parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);"><div class="processing-spinner" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 16px;"></div><div>æ­£åœ¨è§£ææ–‡æœ¬ï¼Œè¯·ç¨å€™...</div></div>';
                    return;
                }
                
                // å¦‚æœæ˜¯ PDFï¼Œä¼˜å…ˆä»æ•°æ®åº“åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æµå¼è¾“å‡º
                if (activeFile.file_type === 'pdf') {
                    const pageNum = page || 1;
                    console.log(`[loadParsedText] å°è¯•ä»æ•°æ®åº“åŠ è½½ç¬¬ ${pageNum} é¡µçš„è§£ææ–‡æœ¬`);
                    
                    // å…ˆå°è¯•ä»æ•°æ®åº“åŠ è½½
                    try {
                        const url = `${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/parsed-text?page=${pageNum}`;
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data.success && data.content) {
                            // æ•°æ®åº“ä¸­æœ‰ç¼“å­˜ï¼Œç›´æ¥æ˜¾ç¤º
                            console.log(`[loadParsedText] âœ… ä»æ•°æ®åº“åŠ è½½ç¬¬ ${pageNum} é¡µçš„è§£ææ–‡æœ¬æˆåŠŸ`);
                            this.renderMarkdown(parsedTextEl, data.content);
                            return;
                        } else {
                            console.log(`[loadParsedText] âš ï¸ æ•°æ®åº“ä¸­ç¬¬ ${pageNum} é¡µçš„è§£ææ–‡æœ¬ä¸å­˜åœ¨`);
                        }
                    } catch (error) {
                        console.error(`[loadParsedText] âŒ ä»æ•°æ®åº“åŠ è½½ç¬¬ ${pageNum} é¡µçš„è§£ææ–‡æœ¬å¤±è´¥:`, error);
                    }
                    
                    // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œä½¿ç”¨æµå¼è¾“å‡ºï¼ˆå®æ—¶è§£ææˆ–é‡æ–°è§£æï¼‰
                    console.log(`[loadParsedText] æ•°æ®åº“ä¸­ç¬¬ ${pageNum} é¡µçš„è§£ææ–‡æœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨æµå¼è¾“å‡º`);
                    await this.loadParsedTextStream(pageNum);
                } else {
                    // å…¶ä»–æ–‡ä»¶ï¼ˆdocx, txt, excel, mdç­‰ï¼‰ï¼Œä½¿ç”¨æœ¬åœ°è§„åˆ™è§£æï¼Œä»æ•°æ®åº“åŠ è½½
                    console.log(`[loadParsedText] å°è¯•ä»æ•°æ®åº“åŠ è½½éPDFæ–‡ä»¶çš„è§£ææ–‡æœ¬ï¼ˆæœ¬åœ°è§„åˆ™è§£æï¼‰`);
                    try {
                        const url = `${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/parsed-text?page=${page || ''}`;
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data.success && data.content) {
                            // æ•°æ®åº“ä¸­æœ‰è§£æç»“æœï¼Œç›´æ¥æ˜¾ç¤º
                            console.log(`[loadParsedText] âœ… ä»æ•°æ®åº“åŠ è½½éPDFæ–‡ä»¶çš„è§£ææ–‡æœ¬æˆåŠŸï¼ˆæœ¬åœ°è§„åˆ™è§£æï¼‰`);
                            this.renderMarkdown(parsedTextEl, data.content);
                        } else {
                            // æ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œæ£€æŸ¥æ–‡æ¡£çŠ¶æ€
                            if (activeFile.status === 'processing') {
                                // æ­£åœ¨å¤„ç†ä¸­ï¼Œæ˜¾ç¤ºå¤„ç†çŠ¶æ€
                                console.log(`[loadParsedText] éPDFæ–‡ä»¶æ­£åœ¨ä½¿ç”¨æœ¬åœ°è§„åˆ™è§£æä¸­ï¼Œæ˜¾ç¤ºå¤„ç†çŠ¶æ€`);
                                parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);"><div class="processing-spinner" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 16px;"></div><div>æ­£åœ¨ä½¿ç”¨æœ¬åœ°è§„åˆ™è§£ææ–‡æœ¬ï¼Œè¯·ç¨å€™...</div></div>';
                            } else {
                                // å·²å®Œæˆä½†æ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œå¯èƒ½æ˜¯è§£æå¤±è´¥æˆ–è¿˜æœªè§£æ
                                console.log(`[loadParsedText] âš ï¸ éPDFæ–‡ä»¶çš„è§£ææ–‡æœ¬ä¸å­˜åœ¨ï¼Œæ–‡æ¡£çŠ¶æ€: ${activeFile.status}`);
                                parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">è§£ææ–‡æœ¬æœªæ‰¾åˆ°ï¼Œå¯èƒ½æ­£åœ¨å¤„ç†ä¸­...</div>';
                            }
                        }
                    } catch (error) {
                        console.error('åŠ è½½è§£ææ–‡æœ¬å¤±è´¥:', error);
                        parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">åŠ è½½è§£ææ–‡æœ¬å¤±è´¥</div>';
                    }
                }
            },
            
            /** æµå¼åŠ è½½è§£ææ–‡æœ¬ï¼ˆPDFï¼‰ */
            loadParsedTextStream: async function(page) {
                const parsedTextEl = document.getElementById('parsed-text-content');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);"><div class="processing-spinner" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 16px;"></div><div>æ­£åœ¨è§£ææ–‡æœ¬ï¼Œè¯·ç¨å€™...</div></div>';
                
                try {
                    const url = `${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/parsed-text/stream?page=${page || 1}`;
                    const eventSource = new EventSource(url);
                    
                    let content = '';
                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'markdown-content';
                    // å¼ºåˆ¶è®¾ç½®æ ·å¼ï¼Œé˜²æ­¢å®¹å™¨æ‰©å±•
                    contentContainer.style.maxWidth = '100%';
                    contentContainer.style.width = '100%';
                    contentContainer.style.wordWrap = 'break-word';
                    contentContainer.style.wordBreak = 'break-word';
                    contentContainer.style.overflowWrap = 'anywhere';
                    contentContainer.style.overflowX = 'hidden';
                    contentContainer.style.boxSizing = 'border-box';
                    parsedTextEl.innerHTML = '';
                    parsedTextEl.appendChild(contentContainer);
                    
                    // ç¡®ä¿å®¹å™¨æœ¬èº«ä¹Ÿæœ‰å›ºå®šå®½åº¦
                    parsedTextEl.style.maxWidth = '100%';
                    parsedTextEl.style.width = '100%';
                    parsedTextEl.style.overflowX = 'hidden';
                    
                    // ä½¿ç”¨é˜²æŠ–æ¥å‡å°‘DOMæ›´æ–°é¢‘ç‡ï¼Œé¿å…ç•Œé¢é—ªçƒ
                    let updateTimer = null;
                    const updateContent = () => {
                        if (updateTimer) {
                            clearTimeout(updateTimer);
                        }
                        updateTimer = setTimeout(() => {
                            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                            const scrollTop = parsedTextEl.scrollTop;
                            const scrollHeight = parsedTextEl.scrollHeight;
                            const isScrolledToBottom = scrollTop + parsedTextEl.clientHeight >= scrollHeight - 10;
                            
                            // ç¡®ä¿å®¹å™¨å®½åº¦ä¸å˜
                            const containerWidth = parsedTextEl.offsetWidth;
                            
                            // æ¸²æŸ“å†…å®¹
                            this.renderMarkdown(contentContainer, content);
                            
                            // å¼ºåˆ¶ä¿æŒå®¹å™¨å®½åº¦
                            if (parsedTextEl.offsetWidth !== containerWidth) {
                                parsedTextEl.style.width = containerWidth + 'px';
                                parsedTextEl.style.maxWidth = containerWidth + 'px';
                            }
                            
                            // ç¡®ä¿å†…å®¹å®¹å™¨å®½åº¦ä¸å˜
                            contentContainer.style.maxWidth = '100%';
                            contentContainer.style.width = '100%';
                            contentContainer.style.overflowX = 'hidden';
                            
                            // å¦‚æœä¹‹å‰æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆè·Ÿéšæ–°å†…å®¹ï¼‰
                            if (isScrolledToBottom) {
                                parsedTextEl.scrollTop = parsedTextEl.scrollHeight;
                            }
                        }, 100); // æ¯100msæœ€å¤šæ›´æ–°ä¸€æ¬¡
                    };
                    
                    eventSource.onmessage = (event) => {
                        // æ¸…ç†æ¥æ”¶åˆ°çš„æ•°æ®
                        let chunk = event.data || '';
                        
                        // ç§»é™¤ markdown å‰ç¼€
                        chunk = chunk.replace(/^markdown\n?/i, '').replace(/^markdown/i, '');
                        
                        // ç§»é™¤å®Œæ•´çš„JSONå¯¹è±¡ï¼ˆå¦‚ {'text': '...'} æˆ– {"text": "..."}ï¼‰
                        chunk = chunk.replace(/\{'text':\s*'([^']*)'\}/g, '$1');
                        chunk = chunk.replace(/\{"text":\s*"([^"]*)"\}/g, '$1');
                        chunk = chunk.replace(/\{'text':\s*([^}]*)\}/g, '$1');
                        chunk = chunk.replace(/\{"text":\s*([^}]*)\}/g, '$1');
                        
                        // ç§»é™¤JSONç»“æ„ç‰‡æ®µï¼ˆå¦‚ }{'text': ' æˆ– }{'text': ç­‰ï¼‰
                        chunk = chunk.replace(/\}\{'text':\s*['"]?/g, '');
                        chunk = chunk.replace(/\}\{"text":\s*['"]?/g, '');
                        chunk = chunk.replace(/\}\s*\{\s*['"]?text['"]?\s*:\s*['"]?/g, '');
                        
                        // ç§»é™¤æ®‹ç•™çš„JSONç»“æ„ï¼ˆå¦‚ 'text': ' æˆ– "text": "ï¼‰
                        chunk = chunk.replace(/['"]?text['"]?\s*:\s*['"]?/g, '');
                        
                        // ç§»é™¤æ®‹ç•™çš„å¤§æ‹¬å·å’Œå¼•å·ï¼ˆå¦‚æœå®ƒä»¬å•ç‹¬å‡ºç°ï¼‰
                        chunk = chunk.replace(/^[{}'"\s]+/, '');
                        chunk = chunk.replace(/[{}'"\s]+$/, '');
                        
                        // ç§»é™¤LaTeXæ•°å­¦å…¬å¼æ ‡è®°
                        chunk = chunk.replace(/\$\$[^$]*\$\$/g, '');
                        chunk = chunk.replace(/\$[^$]*\$/g, '');
                        
                        // ç§»é™¤LaTeXå‘½ä»¤
                        chunk = chunk.replace(/\^\{[^}]*\}/g, '');
                        chunk = chunk.replace(/\\[a-zA-Z]+\*?/g, '');
                        chunk = chunk.replace(/\\[{}]/g, '');
                        
                        // å¤„ç†è½¬ä¹‰å­—ç¬¦ï¼šå°† \n è½¬æ¢ä¸ºå®é™…æ¢è¡Œ
                        chunk = chunk.replace(/\\n/g, '\n');
                        
                        // ä¿ç•™æ¢è¡Œç¬¦ï¼Œä¸è¦ç§»é™¤
                        // åªåˆå¹¶è¿‡å¤šçš„è¿ç»­æ¢è¡Œï¼ˆä¿ç•™æœ€å¤š2ä¸ªï¼‰
                        chunk = chunk.replace(/\n{3,}/g, '\n\n');
                        
                        // ä¸è¦ç§»é™¤å¼€å¤´çš„æ¢è¡Œç¬¦ï¼Œå®ƒä»¬å¯èƒ½æ˜¯æ®µè½åˆ†éš”
                        // åªåœ¨ç¬¬ä¸€ä¸ªchunkæ—¶ç§»é™¤å¼€å¤´çš„æ¢è¡Œ
                        if (content === '' && chunk.startsWith('\n')) {
                            chunk = chunk.replace(/^\n+/, '');
                        }
                        
                        // åªè¦æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬æ¢è¡Œç¬¦ï¼‰ï¼Œå°±æ·»åŠ 
                        if (chunk) {
                            content += chunk;
                            // ä½¿ç”¨é˜²æŠ–æ›´æ–°ï¼Œå‡å°‘é—ªçƒ
                            updateContent();
                        }
                    };
                    
                    eventSource.onerror = (error) => {
                        eventSource.close();
                        // æ¸…é™¤å®šæ—¶å™¨ï¼Œç«‹å³æ›´æ–°æœ€ç»ˆå†…å®¹
                        if (updateTimer) {
                            clearTimeout(updateTimer);
                        }
                        if (content) {
                            // å¦‚æœå·²ç»æœ‰å†…å®¹ï¼Œä¿æŒæ˜¾ç¤º
                            this.renderMarkdown(contentContainer, content);
                            // æ»šåŠ¨åˆ°åº•éƒ¨
                            parsedTextEl.scrollTop = parsedTextEl.scrollHeight;
                        } else {
                            // å°è¯•ä»æ•°æ®åº“åŠ è½½å·²è§£æçš„æ–‡æœ¬
                            this.loadParsedTextFromDB(page);
                        }
                    };
                } catch (error) {
                    console.error('æµå¼åŠ è½½å¤±è´¥:', error);
                    // é™çº§åˆ°æ™®é€šåŠ è½½
                    this.loadParsedTextFromDB(page);
                }
            },
            
            /** ä»æ•°æ®åº“åŠ è½½å·²è§£æçš„æ–‡æœ¬ */
            loadParsedTextFromDB: async function(page) {
                const parsedTextEl = document.getElementById('parsed-text-content');
                try {
                    const url = `${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/parsed-text?page=${page || ''}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success && data.content) {
                        this.renderMarkdown(parsedTextEl, data.content);
                    } else {
                        parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">è§£ææ–‡æœ¬æœªæ‰¾åˆ°</div>';
                    }
                } catch (error) {
                    console.error('åŠ è½½è§£ææ–‡æœ¬å¤±è´¥:', error);
                    parsedTextEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">åŠ è½½è§£ææ–‡æœ¬å¤±è´¥</div>';
                }
            },
            
            /** æ¸²æŸ“ Markdown æ–‡æœ¬ */
            renderMarkdown: function(container, markdownText) {
                if (!markdownText) {
                    container.innerHTML = '';
                    return;
                }
                
                // ç®€å•çš„ Markdown æ¸²æŸ“ï¼ˆå¯ä»¥åç»­é›†æˆ marked.js ç­‰åº“ï¼‰
                let html = markdownText;
                
                // å…ˆå¤„ç†ä»£ç å—ï¼ˆé¿å…ä»£ç å—å†…çš„å†…å®¹è¢«å…¶ä»–è§„åˆ™å¤„ç†ï¼‰
                const codeBlocks = [];
                html = html.replace(/```([\s\S]*?)```/g, (match, code) => {
                    const id = `CODE_BLOCK_${codeBlocks.length}`;
                    const codeStyle = 'style="max-width: 100% !important; width: 100% !important; word-wrap: break-word !important; word-break: break-all !important; overflow-wrap: anywhere !important; overflow-x: hidden !important; white-space: pre-wrap !important; box-sizing: border-box !important; display: block !important;"';
                    codeBlocks.push(`<pre ${codeStyle}><code ${codeStyle}>${code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`);
                    return id;
                });
                
                // å¤„ç†è¡Œå†…ä»£ç 
                const codeStyle = 'style="max-width: 100% !important; word-wrap: break-word !important; word-break: break-all !important; overflow-wrap: anywhere !important; white-space: pre-wrap !important; box-sizing: border-box !important;"';
                html = html.replace(/`([^`]+)`/g, `<code ${codeStyle}>$1</code>`);
                
                // è½¬ä¹‰ HTMLï¼ˆä½†ä¿ç•™å·²å¤„ç†çš„ä»£ç å—æ ‡è®°ï¼‰
                html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                // æ¢å¤ä»£ç å—
                codeBlocks.forEach((codeBlock, index) => {
                    html = html.replace(`CODE_BLOCK_${index}`, codeBlock);
                });
                
                // æŒ‰è¡Œå¤„ç†
                const lines = html.split('\n');
                const processedLines = [];
                let inList = false;
                let listItems = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    const trimmed = line.trim();
                    
                    // æ ‡é¢˜
                    if (trimmed.match(/^###\s+(.+)$/)) {
                        if (inList) {
                            processedLines.push(`<ul>${listItems.join('')}</ul>`);
                            listItems = [];
                            inList = false;
                        }
                        const h3Style = 'style="font-size: clamp(18px, 2vw, 24px); max-width: 100%; word-wrap: break-word; word-break: break-word; overflow-wrap: anywhere; white-space: normal; overflow-x: hidden; box-sizing: border-box;"';
                        processedLines.push(`<h3 ${h3Style}>${trimmed.replace(/^###\s+/, '')}</h3>`);
                    } else if (trimmed.match(/^##\s+(.+)$/)) {
                        if (inList) {
                            processedLines.push(`<ul>${listItems.join('')}</ul>`);
                            listItems = [];
                            inList = false;
                        }
                        const h2Style = 'style="font-size: clamp(20px, 2.2vw, 26px); max-width: 100%; word-wrap: break-word; word-break: break-word; overflow-wrap: anywhere; white-space: normal; overflow-x: hidden; box-sizing: border-box;"';
                        processedLines.push(`<h2 ${h2Style}>${trimmed.replace(/^##\s+/, '')}</h2>`);
                    } else if (trimmed.match(/^#\s+(.+)$/)) {
                        if (inList) {
                            processedLines.push(`<ul>${listItems.join('')}</ul>`);
                            listItems = [];
                            inList = false;
                        }
                        const h1Style = 'style="font-size: clamp(22px, 2.5vw, 30px); max-width: 100%; word-wrap: break-word; word-break: break-word; overflow-wrap: anywhere; white-space: normal; overflow-x: hidden; box-sizing: border-box;"';
                        processedLines.push(`<h1 ${h1Style}>${trimmed.replace(/^#\s+/, '')}</h1>`);
                    } 
                    // åˆ—è¡¨é¡¹
                    else if (trimmed.match(/^[\*\-+]\s+(.+)$/)) {
                        if (!inList) {
                            inList = true;
                        }
                        const content = trimmed.replace(/^[\*\-+]\s+/, '');
                        const liStyle = 'style="font-size: clamp(14px, 1.5vw, 18px); max-width: 100%; word-wrap: break-word; word-break: break-word; overflow-wrap: anywhere; white-space: normal; overflow-x: hidden; box-sizing: border-box;"';
                        listItems.push(`<li ${liStyle}>${content}</li>`);
                    }
                    // ç©ºè¡Œ
                    else if (!trimmed) {
                        if (inList) {
                            processedLines.push(`<ul>${listItems.join('')}</ul>`);
                            listItems = [];
                            inList = false;
                        }
                        processedLines.push('<br>'); // ä¿ç•™ç©ºè¡Œä½œä¸ºæ®µè½åˆ†éš”
                    }
                    // æ™®é€šæ–‡æœ¬è¡Œ
                    else {
                        if (inList) {
                            processedLines.push(`<ul>${listItems.join('')}</ul>`);
                            listItems = [];
                            inList = false;
                        }
                        // å¤„ç†ç²—ä½“å’Œæ–œä½“
                        line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
                        // å¤„ç†é“¾æ¥
                        line = line.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
                        const pStyle = 'style="font-size: clamp(14px, 1.5vw, 18px); max-width: 100%; word-wrap: break-word; word-break: break-word; overflow-wrap: anywhere; white-space: normal; overflow-x: hidden; box-sizing: border-box;"';
                        processedLines.push(`<p ${pStyle}>${line}</p>`);
                    }
                }
                
                // å¤„ç†å‰©ä½™çš„åˆ—è¡¨
                if (inList && listItems.length > 0) {
                    const ulStyle = 'style="font-size: clamp(14px, 1.5vw, 18px); max-width: 100%; word-wrap: break-word; word-break: break-word; overflow-wrap: anywhere; white-space: normal; overflow-x: hidden; box-sizing: border-box; padding-left: clamp(1em, 2vw, 1.5em);"';
                    processedLines.push(`<ul ${ulStyle}>${listItems.join('')}</ul>`);
                }
                
                container.innerHTML = processedLines.join('');
                
                // å¼ºåˆ¶æ‰€æœ‰å­å…ƒç´ éƒ½æœ‰æ­£ç¡®çš„æ ·å¼
                const allElements = container.querySelectorAll('*');
                allElements.forEach(el => {
                    el.style.maxWidth = '100%';
                    el.style.boxSizing = 'border-box';
                    el.style.wordBreak = 'break-all';
                    el.style.overflowWrap = 'anywhere';
                    el.style.overflowX = 'hidden';
                    if (el.tagName === 'PRE' || el.tagName === 'CODE') {
                        el.style.whiteSpace = 'pre-wrap';
                        el.style.width = '100%';
                    }
                });
            },

            /** æ¸²æŸ“ PDF/è§£ææ–‡æœ¬å†…å®¹ */
            renderPDFAndParsedText: async function(page = 1) {
                const pdfContent = document.getElementById('pdf-content');
                const parsedText = document.getElementById('parsed-text-content');

                if (!this.config.activeFileId) {
                    pdfContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">è¯·é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£</div>';
                    parsedText.innerHTML = '';
                    document.getElementById('page-controls').style.display = 'none';
                    return;
                }

                const activeFile = this.config.files.find(f => f.id === this.config.activeFileId);
                if (!activeFile) {
                    pdfContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">æ–‡æ¡£ä¸å­˜åœ¨</div>';
                    parsedText.innerHTML = '';
                    document.getElementById('page-controls').style.display = 'none';
                    return;
                }

                // æ›´æ–°æ€»é¡µæ•°ï¼ˆä¼˜å…ˆä»æ–‡æ¡£å¯¹è±¡è·å–ï¼Œå¦åˆ™ä» API è·å–ï¼‰
                this.config.totalPages = activeFile.total_pages || 0;
                this.config.currentPage = page;
                
                console.log('[é¡µç ] æ–‡æ¡£ä¿¡æ¯:', {
                    id: activeFile.id,
                    status: activeFile.status,
                    total_pages: activeFile.total_pages,
                    config_totalPages: this.config.totalPages
                });

                // å¦‚æœæ€»é¡µæ•°ä¸º0ï¼Œå°è¯•ä» API è·å–é¡µé¢åˆ—è¡¨
                if (this.config.totalPages === 0) {
                    try {
                        console.log('[é¡µç ] å°è¯•ä» API è·å–é¡µé¢åˆ—è¡¨...');
                        const pagesResponse = await fetch(`${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/pages?t=${Date.now()}`);
                        const pagesData = await pagesResponse.json();
                        console.log('[é¡µç ] é¡µé¢åˆ—è¡¨å“åº”:', pagesData);
                        if (pagesData.success && pagesData.total > 0) {
                            this.config.totalPages = pagesData.total;
                            // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                            const fileIndex = this.config.files.findIndex(f => f.id === this.config.activeFileId);
                            if (fileIndex !== -1) {
                                this.config.files[fileIndex].total_pages = pagesData.total;
                            }
                            console.log('[é¡µç ] æˆåŠŸè·å–æ€»é¡µæ•°:', this.config.totalPages);
                        } else {
                            console.log('[é¡µç ] é¡µé¢åˆ—è¡¨ä¸ºç©ºæˆ–è·å–å¤±è´¥');
                        }
                    } catch (e) {
                        console.error('[é¡µç ] è·å–é¡µé¢åˆ—è¡¨å¤±è´¥:', e);
                    }
                }

                // æ›´æ–°é¡µç æ§åˆ¶å™¨
                const pageControls = document.getElementById('page-controls');
                const pageInput = document.getElementById('page-input');
                const pageTotal = document.getElementById('page-total');
                const pagePrev = document.getElementById('page-prev');
                const pageNext = document.getElementById('page-next');

                console.log('[é¡µç ] æ›´æ–°æ§åˆ¶å™¨ï¼Œæ€»é¡µæ•°:', this.config.totalPages);
                
                if (this.config.totalPages > 0) {
                    pageControls.style.display = 'flex';
                    pageInput.value = page;
                    pageTotal.textContent = this.config.totalPages;
                    pagePrev.disabled = page <= 1;
                    pageNext.disabled = page >= this.config.totalPages;
                    console.log('[é¡µç ] é¡µç æ§åˆ¶å™¨å·²æ˜¾ç¤º');
                } else {
                    pageControls.style.display = 'none';
                    console.log('[é¡µç ] é¡µç æ§åˆ¶å™¨å·²éšè—ï¼ˆæ€»é¡µæ•°ä¸º0ï¼‰');
                }

                // å¦‚æœæ–‡æ¡£æ­£åœ¨å¤„ç†ä¸­
                if (activeFile.status === 'processing') {
                    pdfContent.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            <div class="processing-spinner" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 16px;"></div>
                            <div>æ­£åœ¨å¤„ç†æ–‡æ¡£ï¼Œè¯·ç¨å€™...</div>
                        </div>
                    `;
                    parsedText.innerHTML = '';
                    return;
                }

                try {
                    // åŠ è½½é¡µé¢å›¾ç‰‡
                    const imageUrl = `${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/pages/${page}`;
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = `ç¬¬ ${page} é¡µ`;
                    img.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain; transform: scale(' + this.config.imageScale + ') translate(' + (this.config.imageOffsetX || 0) + 'px, ' + (this.config.imageOffsetY || 0) + 'px); transform-origin: center center;';
                    img.className = this.config.imageScale > 1 ? 'zoomed' : '';
                    img.draggable = false; // ç¦ç”¨é»˜è®¤æ‹–æ‹½
                    
                    img.onload = () => {
                        // å›¾ç‰‡åŠ è½½æˆåŠŸåï¼Œå¦‚æœæ€»é¡µæ•°ä»ä¸º0ï¼Œå†æ¬¡å°è¯•è·å–
                        if (this.config.totalPages === 0) {
                            console.log('[é¡µç ] å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œä½†æ€»é¡µæ•°ä¸º0ï¼Œå†æ¬¡å°è¯•è·å–é¡µé¢åˆ—è¡¨');
                            this.fetchPagesCount();
                        }
                    };
                    
                    img.onerror = () => {
                        pdfContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">é¡µé¢ ' + page + ' åŠ è½½å¤±è´¥</div>';
                    };
                    
                    pdfContent.innerHTML = '';
                    pdfContent.appendChild(img);
                    
                    // ç»‘å®šå›¾ç‰‡æ‹–æ‹½åŠŸèƒ½
                    this.setupImageDrag(img);

                    // åŠ è½½è§£ææ–‡æœ¬ï¼ˆMarkdownï¼‰- ä¼˜å…ˆä»æ•°æ®åº“ç¼“å­˜åŠ è½½
                    await this.loadParsedText(page);
                } catch (error) {
                    console.error('åŠ è½½é¡µé¢å¤±è´¥:', error);
                    pdfContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">åŠ è½½é¡µé¢å¤±è´¥</div>';
                }
            },

            // ------------------ äº¤äº’æ–¹æ³• ------------------

            /** åˆ‡æ¢æ´»è·ƒæ–‡ä»¶ */
            setActiveFile: async function(fileId) {
                if (this.config.activeFileId !== fileId) {
                    this.config.activeFileId = fileId;
                    this.config.currentPage = 1;
                    this.config.imageScale = 1.0; // é‡ç½®ç¼©æ”¾
                    this.config.imageOffsetX = 0; // é‡ç½®åç§»
                    this.config.imageOffsetY = 0; // é‡ç½®åç§»
                    const activeFile = this.config.files.find(f => f.id === fileId);
                    if (activeFile) {
                        this.renderSidebar();
                        await this.loadChunksForActiveDocument();
                        await this.renderPDFAndParsedText(1);
                        document.getElementById('doc-title-display').innerHTML = `${activeFile.name} <span class="status-badge">çŸ¥è¯†åˆ‡åˆ†å®¡æ ¸ä¸­</span>`;
                        console.log(`æ–‡ä»¶å·²åˆ‡æ¢åˆ°: ${fileId}`);
                    }
                }
            },

            /**
             * [æ ¸å¿ƒåŠŸèƒ½ç‚¹ 1] ç‚¹å‡»çŸ¥è¯†åº“å¡ç‰‡çš„æ¥æºæ—¶ï¼ŒåŸæ–‡æ¡£è§†å›¾ (PDF)è·³è½¬è‡³å¯¹åº”çš„é¡µé¢ã€‚
             * @param {number} page - è¦è·³è½¬çš„ç›®æ ‡é¡µç ã€‚
             */
            jumpToPage: async function(page) {
                const pdfWrapper = document.getElementById('pdf-wrapper');

                // 1. æ›´æ–° PDF è§†å›¾å†…å®¹
                await this.renderPDFAndParsedText(page);

                // 2. æ·»åŠ è§†è§‰é«˜äº®åé¦ˆ
                pdfWrapper.classList.add('highlighted');
                setTimeout(() => {
                    pdfWrapper.classList.remove('highlighted');
                }, 800);

                // 3. ç¡®ä¿ PDF è§†å›¾å›åˆ°éç¼©æ”¾çŠ¶æ€ (é‡ç½®æ»šåŠ¨æ¡)
                const pdfContent = document.getElementById('pdf-content');
                if (pdfContent.classList.contains('zoomed')) {
                    this.toggleZoom();
                }

                console.log(`å·²è·³è½¬è‡³ PDF ç¬¬ ${page} é¡µ`);
            },

            /** åˆ‡æ¢é¡µç  */
            changePage: function(delta) {
                const newPage = this.config.currentPage + delta;
                if (newPage >= 1 && newPage <= this.config.totalPages) {
                    this.goToPage(newPage);
                }
            },
            
            /** è·³è½¬åˆ°æŒ‡å®šé¡µç  */
            goToPage: async function(page) {
                if (page >= 1 && page <= this.config.totalPages) {
                    await this.renderPDFAndParsedText(page);
                }
            },
            
            /** ç¼©æ”¾å›¾ç‰‡ */
            zoomImage: function(delta) {
                const minScale = 0.5;
                const maxScale = 3.0;
                const scaleStep = 0.2; // å¢å¤§æ­¥é•¿ï¼Œå“åº”æ›´å¿«
                
                this.config.imageScale = Math.max(minScale, Math.min(maxScale, this.config.imageScale + delta * scaleStep));
                
                const img = document.querySelector('#pdf-content img');
                if (img) {
                    this.updateImageTransform(img);
                }
            },
            
            /** æ›´æ–°å›¾ç‰‡å˜æ¢ */
            updateImageTransform: function(img) {
                if (!img) return;
                img.style.transform = 'scale(' + this.config.imageScale + ') translate(' + (this.config.imageOffsetX || 0) + 'px, ' + (this.config.imageOffsetY || 0) + 'px)';
                img.className = this.config.imageScale > 1 ? 'zoomed' : '';
                
                // å¦‚æœæ”¾å¤§ï¼Œå¯ç”¨æ»šåŠ¨
                const wrapper = document.getElementById('pdf-wrapper');
                if (this.config.imageScale > 1) {
                    wrapper.classList.add('scrollable');
                } else {
                    wrapper.classList.remove('scrollable');
                    wrapper.scrollTop = 0;
                    wrapper.scrollLeft = 0;
                    // é‡ç½®åç§»
                    this.config.imageOffsetX = 0;
                    this.config.imageOffsetY = 0;
                }
            },
            
            /** è·å–é¡µé¢æ€»æ•° */
            fetchPagesCount: async function() {
                if (!this.config.activeFileId) return;
                try {
                    const pagesResponse = await fetch(`${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/pages?t=${Date.now()}`);
                    const pagesData = await pagesResponse.json();
                    if (pagesData.success && pagesData.total > 0) {
                        this.config.totalPages = pagesData.total;
                        // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                        const fileIndex = this.config.files.findIndex(f => f.id === this.config.activeFileId);
                        if (fileIndex !== -1) {
                            this.config.files[fileIndex].total_pages = pagesData.total;
                        }
                        // æ›´æ–°é¡µç æ§åˆ¶å™¨æ˜¾ç¤º
                        const pageControls = document.getElementById('page-controls');
                        const pageInput = document.getElementById('page-input');
                        const pageTotal = document.getElementById('page-total');
                        const pagePrev = document.getElementById('page-prev');
                        const pageNext = document.getElementById('page-next');
                        if (pageControls && this.config.totalPages > 0) {
                            pageControls.style.display = 'flex';
                            pageInput.value = this.config.currentPage;
                            pageTotal.textContent = this.config.totalPages;
                            pagePrev.disabled = this.config.currentPage <= 1;
                            pageNext.disabled = this.config.currentPage >= this.config.totalPages;
                            console.log('[é¡µç ] å»¶è¿Ÿè·å–æˆåŠŸï¼Œæ€»é¡µæ•°:', this.config.totalPages);
                        }
                    }
                } catch (e) {
                    console.error('[é¡µç ] å»¶è¿Ÿè·å–é¡µé¢åˆ—è¡¨å¤±è´¥:', e);
                }
            },
            
            /** è®¾ç½®å›¾ç‰‡æ‹–æ‹½åŠŸèƒ½ */
            setupImageDrag: function(img) {
                if (!img) return;
                
                let isDragging = false;
                let startX = 0;
                let startY = 0;
                let startOffsetX = 0;
                let startOffsetY = 0;
                
                img.addEventListener('mousedown', (e) => {
                    if (this.config.imageScale > 1) {
                        isDragging = true;
                        this.config.isDragging = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startOffsetX = this.config.imageOffsetX || 0;
                        startOffsetY = this.config.imageOffsetY || 0;
                        img.classList.add('dragging');
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (isDragging && this.config.imageScale > 1) {
                        const deltaX = e.clientX - startX;
                        const deltaY = e.clientY - startY;
                        this.config.imageOffsetX = startOffsetX + deltaX / this.config.imageScale;
                        this.config.imageOffsetY = startOffsetY + deltaY / this.config.imageScale;
                        this.updateImageTransform(img);
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        this.config.isDragging = false;
                        img.classList.remove('dragging');
                    }
                });
            },

            // ------------------ åˆå§‹åŒ–å’Œè¾…åŠ©å·¥å…· ------------------

            /** æ¨¡å—æ‹–æ‹½è°ƒæ•´å¤§å°é€»è¾‘ (ä¼˜åŒ–ç‰ˆï¼šæ”¯æŒåŠ¨æ€å†…å®¹å’Œç¨³å®šæ‹–æ‹½) */
            makeResizable: function(resizer, prevSibling, isVertical) {
                if (!resizer || !prevSibling) return;
                
                let x = 0;
                let y = 0;
                let prevSize = 0;
                let animationFrameId = null;

                const updateSize = function(dx, dy) {
                    if (isVertical) {
                        // ä¾§è¾¹æ æœ€å° 140px
                        const newWidth = Math.max(140, prevSize + dx);
                        prevSibling.style.width = `${newWidth}px`;
                        prevSibling.style.flexBasis = `${newWidth}px`;
                    } else {
                        // æ¨ªå‘æ‹–æ‹½ï¼šç²¾ç¡®æ§åˆ¶ä¸Šä¸‹åŒºåŸŸçš„é«˜åº¦
                        const parent = prevSibling.parentElement;
                        if (!parent) return;
                        
                        const parentRect = parent.getBoundingClientRect();
                        const resizerRect = resizer.getBoundingClientRect();
                        const parentHeight = parentRect.height;
                        const minTop = 180;   // å¯¹æ¯”è§†å›¾æœ€å°é«˜åº¦
                        const minBottom = 200; // çŸ¥è¯†åˆ‡ç‰‡åˆ—è¡¨æœ€å°é«˜åº¦
                        const resizerHeight = resizerRect.height || 5;

                        let newHeight = prevSize + dy;
                        const maxTop = parentHeight - minBottom - resizerHeight;
                        newHeight = Math.max(minTop, Math.min(maxTop, newHeight));

                        // åŒæ—¶è®¾ç½® height å’Œ flex-basis ç¡®ä¿ç¨³å®šæ€§
                        prevSibling.style.height = `${newHeight}px`;
                        prevSibling.style.flexBasis = `${newHeight}px`;
                        prevSibling.style.flexShrink = '0';
                        prevSibling.style.flexGrow = '0';
                    }
                    animationFrameId = null;
                };

                const mouseMoveHandler = function(e) {
                    const dx = e.clientX - x;
                    const dy = e.clientY - y;

                    if (animationFrameId === null) {
                        animationFrameId = window.requestAnimationFrame(() => updateSize(dx, dy));
                    }
                };

                const mouseDownHandler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    x = e.clientX;
                    y = e.clientY;
                    const rect = prevSibling.getBoundingClientRect();
                    prevSize = isVertical ? rect.width : rect.height;

                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                    resizer.style.borderColor = 'var(--brand-primary)';
                    resizer.style.background = 'rgba(112, 89, 251, 0.15)';
                    document.body.style.cursor = isVertical ? 'col-resize' : 'row-resize';
                    document.body.style.userSelect = 'none';
                };

                const mouseUpHandler = function() {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                    resizer.style.borderColor = 'transparent';
                    resizer.style.background = 'transparent';
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                };

                // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                resizer.removeEventListener('mousedown', mouseDownHandler);
                // æ·»åŠ æ–°çš„ç›‘å¬å™¨
                resizer.addEventListener('mousedown', mouseDownHandler);
            },

            /** åˆå§‹åŒ–åº”ç”¨ */
            init: function() {
                // 1. åŠ è½½æ–‡æ¡£åˆ—è¡¨
                this.loadDocuments();
                
                // 2. ç»‘å®šæ–‡ä»¶ä¸Šä¼ 
                const fileInput = document.getElementById('file-input');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        this.uploadDocuments(files);
                    }
                    e.target.value = ''; // æ¸…ç©ºé€‰æ‹©
                });

                // 3. ç»‘å®šæ‹–æ‹½ä¸Šä¼ 
                const importZone = document.getElementById('import-zone');
                importZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    importZone.classList.add('drag-over');
                });
                
                importZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    importZone.classList.remove('drag-over');
                });
                
                importZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    importZone.classList.remove('drag-over');
                    
                    const files = Array.from(e.dataTransfer.files);
                    const allowedExts = ['.pdf', '.doc', '.docx', '.xlsx', '.xls', '.txt', '.md', '.json'];
                    const validFiles = files.filter(file => {
                        const ext = '.' + file.name.split('.').pop().toLowerCase();
                        return allowedExts.includes(ext);
                    });
                    
                    if (validFiles.length > 0) {
                        this.uploadDocuments(validFiles);
                    } else if (files.length > 0) {
                        alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼  PDFã€Wordã€Excelã€æ–‡æœ¬ç­‰æ ¼å¼');
                    }
                });

                // 4. ç»‘å®šæœç´¢æ¡†
                const searchBox = document.getElementById('file-search');
                if (searchBox) {
                    searchBox.addEventListener('input', (e) => {
                        this.config.searchKeyword = e.target.value;
                        this.renderSidebar();
                    });
                    
                    // æ”¯æŒ ESC é”®æ¸…ç©ºæœç´¢
                    searchBox.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            searchBox.value = '';
                            this.config.searchKeyword = '';
                            this.renderSidebar();
                        }
                    });
                }

                // 5. ç»‘å®šæ‹–æ‹½äº‹ä»¶ï¼ˆè°ƒæ•´å¤§å°ï¼‰
                this.makeResizable(document.getElementById('resizer-sidebar'), document.getElementById('sidebar'), true);
                this.makeResizable(document.getElementById('resizer-horizontal'), document.getElementById('comparison-area'), false);

                // 6. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šåˆ é™¤æŒ‰é’®
                const sidebar = document.getElementById('sidebar-file-list');
                if (sidebar) {
                    sidebar.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.action-link.delete');
                        if (deleteBtn) {
                            e.preventDefault();
                            e.stopPropagation();
                            const docId = deleteBtn.getAttribute('data-doc-id');
                            const docName = deleteBtn.getAttribute('data-doc-name');
                            if (docId && docName) {
                                console.log('ç‚¹å‡»åˆ é™¤æŒ‰é’®:', docId, docName);
                                this.deleteDocument(docId, docName);
                            }
                        }
                    });
                }

                // çŸ¥è¯†åˆ‡ç‰‡åŒºåŸŸçš„åˆ é™¤ / ç¡®è®¤äº‹ä»¶å§”æ‰˜
                const chunksList = document.getElementById('chunks-list');
                if (chunksList) {
                    chunksList.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.action-link.delete');
                        const editBtn = e.target.closest('.action-link.edit');
                        const confirmBtn = e.target.closest('.btn-confirm');
                        const targetBtn = deleteBtn || editBtn || confirmBtn;
                        if (!targetBtn) return;
                        const chunkId = targetBtn.getAttribute('data-chunk-id');
                        if (!chunkId) return;

                        e.preventDefault();
                        e.stopPropagation();

                        if (deleteBtn) {
                            KnowledgeOS.deleteChunk(chunkId);
                        } else if (editBtn) {
                            KnowledgeOS.editChunk(chunkId);
                        } else if (confirmBtn && !confirmBtn.disabled && !confirmBtn.classList.contains('disabled')) {
                            KnowledgeOS.confirmChunk(chunkId);
                        }
                    });
                }

                // 7. ç»‘å®šé¼ æ ‡æ»šè½®ç¼©æ”¾ï¼ˆä¼˜åŒ–å“åº”é€Ÿåº¦ï¼‰
                const pdfWrapper = document.getElementById('pdf-wrapper');
                if (pdfWrapper) {
                    let wheelTimeout = null;
                    pdfWrapper.addEventListener('wheel', (e) => {
                        // æŒ‰ä½ Ctrl é”®æ—¶ç¼©æ”¾ï¼Œæˆ–è€…ç›´æ¥æ»šè½®ç¼©æ”¾ï¼ˆä¸æŒ‰Ctrlï¼‰
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            // æ¸…é™¤ä¹‹å‰çš„å»¶è¿Ÿ
                            if (wheelTimeout) {
                                clearTimeout(wheelTimeout);
                            }
                            // ç«‹å³å“åº”ï¼Œä¸ä½¿ç”¨å»¶è¿Ÿ
                            const delta = e.deltaY > 0 ? -0.2 : 0.2;
                            this.zoomImage(delta);
                        }
                    }, { passive: false });
                }

                // 8. å“åº”å¼å­—ä½“å¤§å°è°ƒæ•´ - ç›‘å¬çª—å£å’Œå®¹å™¨å¤§å°å˜åŒ–
                const textContent = document.getElementById('parsed-text-content');
                if (textContent && window.ResizeObserver) {
                    // ä½¿ç”¨ ResizeObserver ç›‘å¬å®¹å™¨å¤§å°å˜åŒ–
                    const resizeObserver = new ResizeObserver((entries) => {
                        // CSS clamp() å’Œåª’ä½“æŸ¥è¯¢å·²ç»å¤„ç†äº†å¤§éƒ¨åˆ†å“åº”å¼éœ€æ±‚
                        // è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„åŠ¨æ€è°ƒæ•´é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
                        // ç›®å‰ CSS å·²ç»è¶³å¤Ÿï¼Œè¿™é‡Œä¿ç•™æ¥å£ä»¥ä¾¿æœªæ¥æ‰©å±•
                    });
                    resizeObserver.observe(textContent);
                    
                    // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œç¡®ä¿åª’ä½“æŸ¥è¯¢ç”Ÿæ•ˆ
                    let resizeTimeout = null;
                    window.addEventListener('resize', () => {
                        if (resizeTimeout) {
                            clearTimeout(resizeTimeout);
                        }
                        resizeTimeout = setTimeout(() => {
                            // è§¦å‘é‡æ–°è®¡ç®—æ ·å¼ï¼ˆCSS ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
                            // è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„è°ƒæ•´é€»è¾‘
                        }, 100);
                    });
                }

                // 9. ç»‘å®šâ€œè‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åº“â€æŒ‰é’®ï¼ˆè°ƒç”¨å¤§æ¨¡å‹è‡ªåŠ¨åˆ‡ç‰‡ï¼‰
                const btnAutoChunk = document.getElementById('btn-auto-chunk');
                if (btnAutoChunk) {
                    btnAutoChunk.addEventListener('click', async () => {
                        if (!this.config.activeFileId) {
                            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå·²ç»å®Œæˆè§£æçš„æ–‡æ¡£');
                            return;
                        }
                        const confirmRun = confirm('å°†ä½¿ç”¨å¤§æ¨¡å‹åŸºäºå½“å‰æ–‡æ¡£çš„è§£æç»“æœè‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åˆ‡ç‰‡ï¼Œå¯èƒ½ä¼šæ¶ˆè€—ä¸€å®šé¢åº¦ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ');
                        if (!confirmRun) return;
                        await this.autoChunkCurrentDocument();
                    });
                }

                // 10. ç»‘å®šâ€œåˆ›å»ºæ–°åˆ‡ç‰‡â€æŒ‰é’®æ‰“å¼€å¼¹çª—
                const btnCreateManual = document.getElementById('btn-create-manual');
                if (btnCreateManual) {
                    btnCreateManual.addEventListener('click', () => {
                        if (!this.config.activeFileId) {
                            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡æ¡£');
                            return;
                        }
                        this.createChunkManual();
                    });
                }

                console.log("Knowledge OS V8.1 åˆå§‹åŒ–å®Œæˆ.");
            }
        };

        /** è®¾ç½®è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åˆ‡ç‰‡æŒ‰é’®çš„åŠ è½½çŠ¶æ€ */
        KnowledgeOS.setAutoChunkLoading = function(isLoading) {
            this.config.isAutoChunking = !!isLoading;
            const btn = document.getElementById('btn-auto-chunk');
            if (btn) {
                btn.disabled = !!isLoading;
                btn.textContent = isLoading ? 'â³ æ­£åœ¨ç”ŸæˆçŸ¥è¯†åº“â€¦' : 'âœ¨ è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åº“';
            }
        };

        /** åˆ é™¤çŸ¥è¯†åˆ‡ç‰‡ */
        KnowledgeOS.deleteChunk = async function(chunkId) {
            if (!chunkId) return;
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ¥è¯†åˆ‡ç‰‡å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`${this.API_BASE}/api/rag/chunks/${chunkId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    this.config.chunks = (this.config.chunks || []).filter(c => c.id !== chunkId);
                    this.renderChunks();
                    await this.loadDocuments(); // åŒæ­¥åˆ·æ–°æ–‡æ¡£åˆ‡ç‰‡æ•°é‡
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                console.error('åˆ é™¤çŸ¥è¯†åˆ‡ç‰‡å¤±è´¥:', e);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
            }
        };

        /** æ‰“å¼€ç¼–è¾‘/åˆ›å»ºçŸ¥è¯†åˆ‡ç‰‡å¼¹çª— */
        KnowledgeOS.openChunkModal = function(mode, chunk) {
            const overlay = document.getElementById('chunk-modal-overlay');
            const titleEl = document.getElementById('chunk-modal-title');
            const contentEl = document.getElementById('chunk-modal-content');
            const tagsEl = document.getElementById('chunk-modal-tags');
            const pageEl = document.getElementById('chunk-modal-page');

            this._chunkModalMode = mode; // 'edit' | 'create'
            this._editingChunkId = chunk ? chunk.id : null;

            if (mode === 'edit' && chunk) {
                titleEl.textContent = 'ä¿®æ”¹çŸ¥è¯†åˆ‡ç‰‡';
                contentEl.value = chunk.content || '';
                tagsEl.value = (chunk.tags || []).join(', ');
                pageEl.value = chunk.source_page || this.config.currentPage || 1;
            } else {
                titleEl.textContent = 'åˆ›å»ºæ–°çŸ¥è¯†åˆ‡ç‰‡';
                contentEl.value = '';
                tagsEl.value = '';
                pageEl.value = this.config.currentPage || 1;
            }

            overlay.style.display = 'flex';
            contentEl.focus();
        };

        KnowledgeOS.closeChunkModal = function() {
            const overlay = document.getElementById('chunk-modal-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            this._chunkModalMode = null;
            this._editingChunkId = null;
        };

        /** ä¿å­˜å¼¹çª—ä¸­çš„çŸ¥è¯†åˆ‡ç‰‡å†…å®¹ */
        KnowledgeOS.saveChunkFromModal = async function() {
            const contentEl = document.getElementById('chunk-modal-content');
            const tagsEl = document.getElementById('chunk-modal-tags');
            const pageEl = document.getElementById('chunk-modal-page');

            const content = (contentEl.value || '').trim();
            const tagsRaw = (tagsEl.value || '').trim();
            const page = parseInt(pageEl.value || '1', 10) || 1;

            if (!content) {
                alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
                contentEl.focus();
                return;
            }

            const tags = tagsRaw
                ? tagsRaw.split(/[ï¼Œ,]/).map(t => t.trim()).filter(Boolean)
                : [];

            if (this._chunkModalMode === 'edit' && this._editingChunkId) {
                // è°ƒç”¨æ›´æ–°æ¥å£
                try {
                    const resp = await fetch(`${this.API_BASE}/api/rag/chunks/${this._editingChunkId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content,
                            tags,
                            source_page: page
                        })
                    });
                    const data = await resp.json();
                    if (data.success && data.chunk) {
                        this.config.chunks = (this.config.chunks || []).map(c =>
                            c.id === this._editingChunkId ? data.chunk : c
                        );
                        this.renderChunks();
                        this.closeChunkModal();
                    } else {
                        alert('æ›´æ–°å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (e) {
                    console.error('æ›´æ–°çŸ¥è¯†åˆ‡ç‰‡å¤±è´¥:', e);
                    alert('æ›´æ–°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
                }
            } else if (this._chunkModalMode === 'create') {
                if (!this.config.activeFileId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡æ¡£');
                    return;
                }
                try {
                    const resp = await fetch(`${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/chunks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content,
                            tags,
                            source_page: page
                        })
                    });
                    const data = await resp.json();
                    if (data.success && data.chunk) {
                        this.config.chunks = (this.config.chunks || []).concat([data.chunk]);
                        this.renderChunks();
                        await this.loadDocuments(); // æ›´æ–°åˆ‡ç‰‡æ•°é‡
                        this.closeChunkModal();
                    } else {
                        alert('åˆ›å»ºå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (e) {
                    console.error('åˆ›å»ºçŸ¥è¯†åˆ‡ç‰‡å¤±è´¥:', e);
                    alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
                }
            }
        };

        /** å¤–éƒ¨è°ƒç”¨ï¼šç¼–è¾‘ç°æœ‰åˆ‡ç‰‡ */
        KnowledgeOS.editChunk = function(chunkId) {
            const chunk = (this.config.chunks || []).find(c => c.id === chunkId);
            if (!chunk) {
                alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„çŸ¥è¯†åˆ‡ç‰‡');
                return;
            }
            this.openChunkModal('edit', chunk);
        };

        /** å¤–éƒ¨è°ƒç”¨ï¼šåˆ›å»ºæ–°åˆ‡ç‰‡ */
        KnowledgeOS.createChunkManual = function() {
            this.openChunkModal('create', null);
        };

        /** ç¡®è®¤çŸ¥è¯†åˆ‡ç‰‡å…¥åº“ */
        KnowledgeOS.confirmChunk = async function(chunkId) {
            if (!chunkId) return;
            try {
                const response = await fetch(`${this.API_BASE}/api/rag/chunks/${chunkId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'confirmed' })
                });
                const data = await response.json();
                if (data.success) {
                    this.config.chunks = (this.config.chunks || []).map(c => c.id === chunkId ? data.chunk : c);
                    this.renderChunks();
                } else {
                    alert('ç¡®è®¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                console.error('ç¡®è®¤çŸ¥è¯†åˆ‡ç‰‡å¤±è´¥:', e);
                alert('ç¡®è®¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
            }
        };

        /** ä½¿ç”¨å¤§æ¨¡å‹è‡ªåŠ¨ä¸ºå½“å‰æ–‡æ¡£ç”ŸæˆçŸ¥è¯†åˆ‡ç‰‡ */
        KnowledgeOS.autoChunkCurrentDocument = async function() {
            if (!this.config.activeFileId) return;
            try {
                this.setAutoChunkLoading(true);
                const response = await fetch(`${this.API_BASE}/api/rag/documents/${this.config.activeFileId}/auto-chunk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chunker_type: 'semantic',
                        chunk_size: 500,
                        chunk_overlap: 50,
                        min_chunk_size: 100
                    })
                });
                const data = await response.json();
                if (data.success) {
                    if (Array.isArray(data.chunks)) {
                        this.config.chunks = (this.config.chunks || []).concat(data.chunks);
                        this.renderChunks();
                    } else {
                        await this.loadChunksForActiveDocument();
                    }
                    await this.loadDocuments();
                } else {
                    alert('è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åˆ‡ç‰‡å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                console.error('è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åˆ‡ç‰‡å¤±è´¥:', e);
                alert('è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åˆ‡ç‰‡å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
            } finally {
                this.setAutoChunkLoading(false);
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ‰§è¡Œåˆå§‹åŒ–
        window.onload = function() {
            KnowledgeOS.init();

            // å¼¹çª—æŒ‰é’®ç»‘å®šï¼ˆå…³é—­ / å–æ¶ˆ / ä¿å­˜ï¼‰
            const overlay = document.getElementById('chunk-modal-overlay');
            const closeBtn = document.getElementById('chunk-modal-close-btn');
            const cancelBtn = document.getElementById('chunk-modal-cancel-btn');
            const saveBtn = document.getElementById('chunk-modal-save-btn');

            if (closeBtn) closeBtn.onclick = () => KnowledgeOS.closeChunkModal();
            if (cancelBtn) cancelBtn.onclick = () => KnowledgeOS.closeChunkModal();
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        KnowledgeOS.closeChunkModal();
                    }
                });
            }
            if (saveBtn) {
                saveBtn.onclick = () => KnowledgeOS.saveChunkFromModal();
            }
        };
    </script>
</body>
</html>