<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge OS - çŸ¥è¯†åº“æ™ºèƒ½å·¥ä½œå° V8.1 (Refactored)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS ä¿æŒ V8.0 â€œæ˜Ÿäº‘â€é£æ ¼ï¼Œç¡®ä¿è§†è§‰ä¸€è‡´æ€§ */
        :root {
            --bg-universe: #0b0c15;
            --bg-sidebar: #12131f;
            --bg-card: #1c1d2e;
            --bg-card-hover: #232438;
            --border-color: rgba(112, 112, 155, 0.15);
            --brand-primary: #7059fb;
            --brand-cyan: #00f0ff;
            --brand-success: #00d2b6;
            --brand-warning: #ffb86c;
            --text-main: #ffffff;
            --text-secondary: #8f9bb3;
            --radius-lg: 12px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Noto Sans SC', sans-serif; background-color: var(--bg-universe); color: var(--text-main); height: 100vh; overflow: hidden; background-image: radial-gradient(circle at 15% 50%, rgba(112, 89, 251, 0.08), transparent 25%), radial-gradient(circle at 85% 30%, rgba(0, 240, 255, 0.05), transparent 25%); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }

        .app-container { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 260px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 24px 16px; z-index: 100; }
        .logo-area { font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 30px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .logo-dot { width: 8px; height: 8px; background: var(--brand-primary); border-radius: 50%; box-shadow: 0 0 8px var(--brand-primary); }
        .btn-import { width: 100%; padding: 12px; border: 1px dashed var(--brand-primary); background: rgba(112, 89, 251, 0.05); color: var(--brand-primary); border-radius: 8px; cursor: pointer; transition: 0.3s; text-align: center; margin-bottom: 30px; font-size: 14px; position: relative; }
        .btn-import:hover { background: rgba(112, 89, 251, 0.15); box-shadow: 0 0 12px rgba(112, 89, 251, 0.2); }
        .btn-import.drag-over { background: rgba(112, 89, 251, 0.25); border-color: var(--brand-primary); border-style: solid; box-shadow: 0 0 20px rgba(112, 89, 251, 0.4); }
        .file-list-header { font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; }
        .file-item { padding: 12px 14px; border-radius: 8px; margin-bottom: 8px; transition: all 0.2s; border-left: 3px solid transparent; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .file-item:hover { background: rgba(255,255,255,0.03); }
        .file-item.active { background: rgba(112, 89, 251, 0.1); border-left-color: var(--brand-primary); }
        .file-item-content { flex: 1; cursor: pointer; min-width: 0; }
        .file-name { font-size: 14px; margin-bottom: 4px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 12px; color: var(--text-secondary); display: flex; justify-content: space-between; }
        .status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; }

        .main-workspace { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-header { height: 60px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; background: rgba(18, 19, 31, 0.8); backdrop-filter: blur(10px); }
        .doc-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 12px; }
        .status-badge { font-size: 12px; padding: 4px 10px; background: rgba(255, 184, 108, 0.1); color: var(--brand-warning); border: 1px solid rgba(255, 184, 108, 0.3); border-radius: 20px; }
        .last-update { font-size: 12px; color: var(--text-secondary); }

        .resizer { background: transparent; z-index: 50; transition: 0.2s; }
        .resizer-x { width: 5px; cursor: col-resize; border-left: 1px solid transparent; }
        .resizer-y { height: 5px; cursor: row-resize; border-top: 1px solid transparent; }
        .resizer:hover { border-color: var(--brand-primary); }

        .comparison-container { height: 55%; display: flex; background-color: var(--bg-universe); }
        .panel { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-universe); border-right: 1px solid var(--border-color); }
        .panel:last-child { border-right: none; }

        .panel-header { height: 40px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(28, 29, 46, 0.5); border-bottom: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary); font-weight: 600; }
        .header-action { color: var(--brand-primary); cursor: pointer; }

        .panel-body { flex: 1; position: relative; overflow: hidden; padding: 0; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .panel-body.scrollable { overflow: auto; align-items: flex-start; justify-content: flex-start; }
        .panel-body.highlighted { background-color: rgba(0, 240, 255, 0.08); } /* è·³è½¬é«˜äº®æ•ˆæœ */

        .pdf-image-mock { max-width: 100%; max-height: 100%; object-fit: contain; transition: all 0.3s; width: 80%; height: 80%; background: #26273b; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #586075; border: 1px dashed rgba(255,255,255,0.1); }
        .pdf-image-mock.zoomed { max-width: none; max-height: none; width: 150%; }

        .text-stream-content { padding: 30px; overflow-y: auto; color: #d1d5db; font-size: 14px; line-height: 1.8; }
        .text-stream-content h3 { color: var(--text-main); margin-top: 0; font-size: 18px; }
        .highlight-text { color: var(--brand-cyan); border-bottom: 1px dashed var(--brand-cyan); padding-bottom: 1px; }

        .chunks-container {
            flex-grow: 1;
            background-color: rgba(18, 19, 31, 0.6);
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--border-color);
            /* ğŸš€ ä¼˜åŒ– 1: è§£é™¤æ‹–æ‹½é™åˆ¶ï¼Œå…è®¸è¢«å‹ç¼©åˆ°æœ€å°é«˜åº¦ */
            min-height: 0;
        }
        .chunks-header { padding: 15px 24px; display: flex; justify-content: space-between; align-items: center; }
        .section-title { font-size: 14px; font-weight: 700; color: var(--text-secondary); }
        .btn-create { background: var(--brand-primary); color: #fff; border: none; padding: 6px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; box-shadow: 0 2px 10px rgba(112, 89, 251, 0.3); transition: 0.2s; }

        .chunks-list { flex: 1; padding: 0 24px 30px 24px; overflow-y: auto; }
        .chunk-card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; position: relative; transition: all 0.3s; }
        .chunk-card:hover { border-color: var(--brand-primary); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); background-color: var(--bg-card-hover); }
        .chunk-id { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; display: block; }
        .chunk-content { font-size: 14px; color: var(--text-main); margin-bottom: 20px; line-height: 1.6; }

        .chunk-footer { display: flex; align-items: center; justify-content: space-between; }
        .tags-group { display: flex; gap: 8px; align-items: center; }
        .tag { background: rgba(255, 255, 255, 0.05); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: var(--text-secondary); }

        .source-btn { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: rgba(112, 89, 251, 0.1); border: 1px solid rgba(112, 89, 251, 0.3); color: var(--brand-primary); border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .source-btn:hover { background: var(--brand-primary); color: #fff; }

        .actions-group { display: flex; gap: 12px; }
        .action-link { font-size: 12px; cursor: pointer; color: var(--text-secondary); transition: 0.2s; background: transparent; border: none; display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; }
        .action-link:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .action-link.delete { color: var(--text-secondary); font-size: 14px; padding: 6px 8px; }
        .action-link.delete:hover { color: #ff4757; background: rgba(255, 71, 87, 0.15); }

        .btn-confirm { background: rgba(0, 210, 182, 0.1); color: var(--brand-success); border: 1px solid rgba(0, 210, 182, 0.3); padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .btn-confirm:hover { background: var(--brand-success); color: #000; }
    </style>
</head>
<body>

    <div class="app-container">

        <aside class="sidebar" id="sidebar">
            <div class="logo-area"><div class="logo-dot"></div>Sandbox OS</div>
            <div class="btn-import" id="import-zone" onclick="document.getElementById('file-input').click()">
                + å¯¼å…¥æ–°æ–‡æ¡£<br>
                <span style="font-size: 11px; opacity: 0.7;">æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</span>
            </div>
            <input type="file" id="file-input" style="display: none;" multiple accept=".pdf,.docx,.xlsx,.xls,.txt,.md,.json">
            <div class="file-list-header">çŸ¥è¯†æºåˆ—è¡¨ (<span id="file-count">0</span>)</div>
            <div id="sidebar-file-list"></div>
        </aside>

        <div class="resizer resizer-x" id="resizer-sidebar"></div>

        <main class="main-workspace">
            <header class="top-header">
                <div class="doc-title" id="doc-title-display"></div>
                <div class="last-update">æœ€åæ›´æ–°: 10åˆ†é’Ÿå‰</div>
            </header>

            <section class="comparison-container" id="comparison-area">

                <div class="panel">
                    <div class="panel-header">
                        <span>åŸæ–‡æ¡£è§†å›¾ (PDF)</span>
                        <div class="header-action" onclick="KnowledgeOS.toggleZoom()">ğŸ” ç¼©æ”¾è§†å›¾ (æµ‹è¯•æ»šåŠ¨æ¡)</div>
                    </div>
                    <div class="panel-body" id="pdf-wrapper">
                        <div class="pdf-image-mock" id="pdf-content"></div>
                    </div>
                </div>

                <div class="resizer resizer-x" id="resizer-panel"></div>

                <div class="panel">
                    <div class="panel-header">
                        <span>è§£ææ–‡æœ¬æµ (AI æ¸…æ´—)</span>
                        <span style="color: var(--brand-cyan)">â— å·²å®Œæˆæ¸…æ´—</span>
                    </div>
                    <div class="text-stream-content" id="parsed-text-content"></div>
                </div>
            </section>

            <div class="resizer resizer-y" id="resizer-horizontal"></div>

            <section class="chunks-container">
                <div class="chunks-header">
                    <span class="section-title" id="chunks-section-title">çŸ¥è¯†åˆ‡ç‰‡åˆ—è¡¨ (å…± 0 æ¡)</span>
                    <button class="btn-create">âœ¨ åˆ›å»ºæ–°åˆ‡ç‰‡</button>
                </div>
                <div class="chunks-list" id="chunks-list"></div>
            </section>
        </main>
    </div>

    <script>
        // =========================================================
        //                 KNOWLEDGE OS API (V8.1)
        // =========================================================
        const KnowledgeOS = {
            // ------------------ æ¥å£é…ç½® ------------------
            API_BASE: `${window.location.protocol}//${window.location.host}`,
            
            config: {
                activeFileId: null, // å½“å‰æ´»è·ƒæ–‡ä»¶ ID
                files: [],
                chunks: []
            },

            // ------------------ æ¸²æŸ“æ¨¡å— ------------------

            /** æ¸²æŸ“å·¦ä¾§æ–‡ä»¶åˆ—è¡¨ */
            renderSidebar: function() {
                const list = document.getElementById('sidebar-file-list');
                document.getElementById('file-count').textContent = this.config.files.length;
                
                if (this.config.files.length === 0) {
                    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">æš‚æ— æ–‡æ¡£ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ </div>';
                    return;
                }
                
                list.innerHTML = this.config.files.map(file => `
                    <div class="file-item ${file.id === this.config.activeFileId ? 'active' : ''}">
                        <div class="file-item-content" onclick="KnowledgeOS.setActiveFile('${file.id}')">
                            <span class="file-name">${file.name}</span>
                            <div class="file-meta">
                                <span style="color: ${file.status_color || 'var(--text-secondary)'};">
                                    <span class="status-dot" style="background:${file.status_color || 'var(--text-secondary)'}"></span>${this.getStatusText(file.status)}
                                </span>
                                <span>${file.chunks_count || 0} åˆ‡ç‰‡</span>
                            </div>
                        </div>
                        <button class="action-link delete" data-doc-id="${file.id}" data-doc-name="${file.name.replace(/"/g, '&quot;')}" title="åˆ é™¤æ–‡æ¡£" style="flex-shrink: 0;">ğŸ—‘</button>
                    </div>
                `).join('');
            },
            
            /** è·å–çŠ¶æ€æ–‡æœ¬ */
            getStatusText: function(status) {
                const statusMap = {
                    'pending': 'å¾…å®¡æ ¸',
                    'processing': 'å¤„ç†ä¸­',
                    'completed': 'å·²å…¥åº“',
                    'archived': 'å·²å½’æ¡£',
                    'failed': 'å¤±è´¥'
                };
                return statusMap[status] || status;
            },
            
            /** åŠ è½½æ–‡æ¡£åˆ—è¡¨ */
            loadDocuments: async function() {
                try {
                    // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    const url = `${this.API_BASE}/api/rag/documents?t=${Date.now()}`;
                    console.log('åŠ è½½æ–‡æ¡£åˆ—è¡¨:', url);
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    const data = await response.json();
                    console.log('æ–‡æ¡£åˆ—è¡¨å“åº”:', data);
                    if (data.success) {
                        this.config.files = data.documents;
                        console.log(`åŠ è½½åˆ° ${this.config.files.length} ä¸ªæ–‡æ¡£`);
                        this.renderSidebar();
                        // å¦‚æœå½“å‰æ´»è·ƒæ–‡ä»¶å·²è¢«åˆ é™¤ï¼Œæ¸…ç©ºæ´»è·ƒçŠ¶æ€
                        if (this.config.activeFileId && !this.config.files.find(f => f.id === this.config.activeFileId)) {
                            this.config.activeFileId = null;
                            document.getElementById('doc-title-display').innerHTML = '';
                            this.config.chunks = [];
                            this.renderChunks();
                            this.renderPDFAndParsedText(1);
                        }
                        if (this.config.files.length > 0 && !this.config.activeFileId) {
                            this.setActiveFile(this.config.files[0].id);
                        }
                    } else {
                        console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', data.error);
                    }
                } catch (error) {
                    console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
                }
            },
            
            /** ä¸Šä¼ æ–‡æ¡£ */
            uploadDocument: async function(file) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch(`${this.API_BASE}/api/rag/documents/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        await this.loadDocuments();
                        alert('æ–‡æ¡£ä¸Šä¼ æˆåŠŸ');
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                }
            },
            
            /** åˆ é™¤æ–‡æ¡£ */
            deleteDocument: async function(documentId, documentName) {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ "${documentName}" å—ï¼Ÿ\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å…³çš„æ‰€æœ‰åˆ‡ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`)) {
                    return;
                }
                
                try {
                    console.log(`æ­£åœ¨åˆ é™¤æ–‡æ¡£: ${documentId}`);
                    const url = `${this.API_BASE}/api/rag/documents/${documentId}`;
                    console.log(`åˆ é™¤è¯·æ±‚ URL: ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log(`åˆ é™¤å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('åˆ é™¤å“åº”é”™è¯¯:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('åˆ é™¤å“åº”æ•°æ®:', data);
                    
                    if (data.success) {
                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ´»è·ƒæ–‡ä»¶ï¼Œæ¸…ç©ºæ´»è·ƒçŠ¶æ€
                        if (this.config.activeFileId === documentId) {
                            this.config.activeFileId = null;
                            document.getElementById('doc-title-display').innerHTML = '';
                            this.config.chunks = [];
                            this.renderChunks();
                            this.renderPDFAndParsedText(1);
                        }
                        // é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨
                        await this.loadDocuments();
                        alert('æ–‡æ¡£åˆ é™¤æˆåŠŸ');
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            },

            /** æ¸²æŸ“çŸ¥è¯†åˆ‡ç‰‡åˆ—è¡¨ */
            renderChunks: function() {
                const list = document.getElementById('chunks-list');
                document.getElementById('chunks-section-title').innerText = `çŸ¥è¯†åˆ‡ç‰‡åˆ—è¡¨ (å…± ${this.config.chunks.length} æ¡)`;

                if (this.config.chunks.length === 0) {
                    list.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">æš‚æ— çŸ¥è¯†åˆ‡ç‰‡</div>';
                    return;
                }

                list.innerHTML = this.config.chunks.map(chunk => `
                    <div class="chunk-card">
                        <span class="chunk-id">ID: ${chunk.id}</span>
                        <div class="chunk-content">${chunk.content}</div>
                        <div class="chunk-footer">
                            <div class="tags-group">
                                ${(chunk.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                                ${chunk.source_page ? `<div class="source-btn" onclick="KnowledgeOS.jumpToPage(${chunk.source_page})">ğŸ“„ æ¥æº: ç¬¬ ${chunk.source_page} é¡µ</div>` : ''}
                            </div>
                            <div class="actions-group">
                                <button class="action-link delete">ğŸ—‘ åˆ é™¤</button>
                                <button class="action-link">âœï¸ ä¿®æ”¹</button>
                                <button class="btn-confirm">âœ” ç¡®è®¤å…¥åº“</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            /** æ¸²æŸ“ PDF/è§£ææ–‡æœ¬å†…å®¹ (æ¨¡æ‹Ÿ) */
            renderPDFAndParsedText: function(page = 3) {
                const pdfContent = document.getElementById('pdf-content');
                const parsedText = document.getElementById('parsed-text-content');

                // æ¨¡æ‹Ÿ PDF æ¸²æŸ“
                pdfContent.innerHTML = `[ PDF é¢„è§ˆåŒºåŸŸ ]<br>ç¬¬ ${page} é¡µ`;

                // æ¨¡æ‹Ÿè§£ææ–‡æœ¬æ¸²æŸ“
                parsedText.innerHTML = `
                    <h3>ç¬¬ ${page} é¡µå†…å®¹æ¦‚è¦</h3>
                    <p style="opacity: 0.6; font-size: 12px; margin-bottom: 20px;">[ç³»ç»Ÿæç¤º] æˆåŠŸåŠ è½½ ${this.config.activeFileId} çš„ç¬¬ ${page} é¡µå†…å®¹ã€‚</p>
                    <p>è¿™æ˜¯ä»æ–‡æ¡£ä¸­è§£æå‡ºçš„æ ¸å¿ƒæ–‡æœ¬ã€‚å…·ä½“åˆ‡ç‰‡æ¥è‡ªè¿™é‡Œ... </p>
                    <p>ï¼ˆæ­¤å¤„æ¨¡æ‹Ÿè¯¥é¡µé¢çš„è§£æå†…å®¹ï¼‰</p>
                `;
            },

            // ------------------ äº¤äº’æ–¹æ³• ------------------

            /** åˆ‡æ¢æ´»è·ƒæ–‡ä»¶ */
            setActiveFile: function(fileId) {
                if (this.config.activeFileId !== fileId) {
                    this.config.activeFileId = fileId;
                    const activeFile = this.config.files.find(f => f.id === fileId);
                    if (activeFile) {
                        this.renderSidebar();
                        this.renderChunks();
                        this.renderPDFAndParsedText(1);
                        document.getElementById('doc-title-display').innerHTML = `${activeFile.name} <span class="status-badge">çŸ¥è¯†åˆ‡åˆ†å®¡æ ¸ä¸­</span>`;
                        console.log(`æ–‡ä»¶å·²åˆ‡æ¢åˆ°: ${fileId}`);
                    }
                }
            },

            /**
             * [æ ¸å¿ƒåŠŸèƒ½ç‚¹ 1] ç‚¹å‡»çŸ¥è¯†åº“å¡ç‰‡çš„æ¥æºæ—¶ï¼ŒåŸæ–‡æ¡£è§†å›¾ (PDF)è·³è½¬è‡³å¯¹åº”çš„é¡µé¢ã€‚
             * @param {number} page - è¦è·³è½¬çš„ç›®æ ‡é¡µç ã€‚
             */
            jumpToPage: function(page) {
                const pdfWrapper = document.getElementById('pdf-wrapper');

                // 1. æ›´æ–° PDF è§†å›¾å†…å®¹
                this.renderPDFAndParsedText(page);

                // 2. æ·»åŠ è§†è§‰é«˜äº®åé¦ˆ
                pdfWrapper.classList.add('highlighted');
                setTimeout(() => {
                    pdfWrapper.classList.remove('highlighted');
                }, 800);

                // 3. ç¡®ä¿ PDF è§†å›¾å›åˆ°éç¼©æ”¾çŠ¶æ€ (é‡ç½®æ»šåŠ¨æ¡)
                const pdfContent = document.getElementById('pdf-content');
                if (pdfContent.classList.contains('zoomed')) {
                    this.toggleZoom();
                }

                console.log(`å·²è·³è½¬è‡³ PDF ç¬¬ ${page} é¡µ`);
            },

            /** åˆ‡æ¢ç¼©æ”¾çŠ¶æ€ (æ™ºèƒ½æ»šåŠ¨æ¡) */
            toggleZoom: function() {
                const wrapper = document.getElementById('pdf-wrapper');
                const content = document.getElementById('pdf-content');

                content.classList.toggle('zoomed');
                wrapper.classList.toggle('scrollable', content.classList.contains('zoomed'));

                if (!content.classList.contains('zoomed')) {
                    wrapper.scrollTop = 0;
                    wrapper.scrollLeft = 0;
                }
            },

            // ------------------ åˆå§‹åŒ–å’Œè¾…åŠ©å·¥å…· ------------------

            /** æ¨¡å—æ‹–æ‹½è°ƒæ•´å¤§å°é€»è¾‘ (ğŸš€ ä¼˜åŒ– 2: ä½¿ç”¨ requestAnimationFrame æé«˜æµç•…åº¦) */
            makeResizable: function(resizer, prevSibling, isVertical) {
                let x = 0;
                let y = 0;
                let prevSize = 0;
                let animationFrameId = null; // ç”¨äºå­˜å‚¨ rAF å¥æŸ„

                const updateSize = function(dx, dy) {
                    if (isVertical) {
                        // ç¡®ä¿æœ€å°å®½åº¦ï¼Œé˜²æ­¢æ‹–åˆ°çœ‹ä¸è§ (ä¾§è¾¹æ æœ€å° 100px)
                        const newWidth = Math.max(100, prevSize + dx);
                        prevSibling.style.width = `${newWidth}px`;
                    } else {
                        // ç¡®ä¿æœ€å°é«˜åº¦ (å¯¹æ¯”è§†å›¾æœ€å° 100px)
                        const newHeight = Math.max(100, prevSize + dy);
                        // å½“æ‹–æ‹½æ”¹å˜ height æ—¶ï¼Œflex å¸ƒå±€ä¼šè‡ªåŠ¨è°ƒæ•´ä¸‹æ–¹ content çš„å¤§å°
                        prevSibling.style.height = `${newHeight}px`;
                    }
                    animationFrameId = null;
                };

                const mouseMoveHandler = function(e) {
                    const dx = e.clientX - x;
                    const dy = e.clientY - y;

                    // åªæœ‰åœ¨æ²¡æœ‰ç­‰å¾…çš„åŠ¨ç”»å¸§æ—¶æ‰è¯·æ±‚æ–°çš„å¸§
                    if (animationFrameId === null) {
                        animationFrameId = window.requestAnimationFrame(() => updateSize(dx, dy));
                    }
                };

                const mouseDownHandler = function(e) {
                    e.preventDefault(); // é˜»æ­¢æ–‡æœ¬é€‰æ‹©
                    x = e.clientX;
                    y = e.clientY;
                    const rect = prevSibling.getBoundingClientRect();
                    prevSize = isVertical ? rect.width : rect.height;

                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                    resizer.style.borderColor = 'var(--brand-primary)';
                    // æ‹–æ‹½æ—¶ï¼Œè®¾ç½®å…¨å±€å…‰æ ‡ä»¥æé«˜ä½“éªŒ
                    document.body.style.cursor = isVertical ? 'col-resize' : 'row-resize';
                };

                const mouseUpHandler = function() {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                    resizer.style.borderColor = 'transparent';
                    document.body.style.cursor = ''; // æ¢å¤é»˜è®¤å…‰æ ‡
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                };

                resizer.addEventListener('mousedown', mouseDownHandler);
            },

            /** åˆå§‹åŒ–åº”ç”¨ */
            init: function() {
                // 1. åŠ è½½æ–‡æ¡£åˆ—è¡¨
                this.loadDocuments();
                
                // 2. ç»‘å®šæ–‡ä»¶ä¸Šä¼ 
                const fileInput = document.getElementById('file-input');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    files.forEach(file => this.uploadDocument(file));
                    e.target.value = ''; // æ¸…ç©ºé€‰æ‹©
                });

                // 3. ç»‘å®šæ‹–æ‹½ä¸Šä¼ 
                const importZone = document.getElementById('import-zone');
                importZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    importZone.classList.add('drag-over');
                });
                
                importZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    importZone.classList.remove('drag-over');
                });
                
                importZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    importZone.classList.remove('drag-over');
                    
                    const files = Array.from(e.dataTransfer.files);
                    const allowedExts = ['.pdf', '.docx', '.xlsx', '.xls', '.txt', '.md', '.json'];
                    const validFiles = files.filter(file => {
                        const ext = '.' + file.name.split('.').pop().toLowerCase();
                        return allowedExts.includes(ext);
                    });
                    
                    if (validFiles.length > 0) {
                        validFiles.forEach(file => this.uploadDocument(file));
                    } else if (files.length > 0) {
                        alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼  PDFã€Wordã€Excelã€æ–‡æœ¬ç­‰æ ¼å¼');
                    }
                });

                // 4. ç»‘å®šæ‹–æ‹½äº‹ä»¶ï¼ˆè°ƒæ•´å¤§å°ï¼‰
                this.makeResizable(document.getElementById('resizer-sidebar'), document.getElementById('sidebar'), true);
                this.makeResizable(document.getElementById('resizer-horizontal'), document.getElementById('comparison-area'), false);

                // 5. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šåˆ é™¤æŒ‰é’®
                const sidebar = document.getElementById('sidebar-file-list');
                if (sidebar) {
                    sidebar.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.action-link.delete');
                        if (deleteBtn) {
                            e.preventDefault();
                            e.stopPropagation();
                            const docId = deleteBtn.getAttribute('data-doc-id');
                            const docName = deleteBtn.getAttribute('data-doc-name');
                            if (docId && docName) {
                                console.log('ç‚¹å‡»åˆ é™¤æŒ‰é’®:', docId, docName);
                                this.deleteDocument(docId, docName);
                            }
                        }
                    });
                }

                console.log("Knowledge OS V8.1 åˆå§‹åŒ–å®Œæˆ.");
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ‰§è¡Œåˆå§‹åŒ–
        window.onload = function() {
            KnowledgeOS.init();
        };
    </script>
</body>
</html>