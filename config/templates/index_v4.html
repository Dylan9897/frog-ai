<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox OS Pro Â· AI Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght=400&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        // è•‰ç»¿è›™å“ç‰Œè‰² - é«˜é¥±å’Œç‰ˆ
                        banana: {
                            300: '#fde047',
                            400: '#facc15', // ä¸»é»„
                            500: '#eab308',
                            shadow: '#ca8a04' // æ·±é»„é˜´å½±
                        },
                        frog: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            400: '#4ade80', // è§å…‰ç»¿
                            500: '#22c55e', // ä¸»ç»¿
                            600: '#16a34a',
                            800: '#166534',
                            900: '#14532d',
                            shadow: '#15803d' // æ·±ç»¿é˜´å½±
                        },
                        surface: {
                            light: '#ffffff',
                            dark: '#f8fafc'
                        }
                    },
                    screens: {
                        '2xl': '1536px',
                        '3xl': '1920px',
                    },
                    boxShadow: {
                        'pop': '4px 4px 0px 0px rgba(0,0,0,0.1)',
                        'pop-hover': '6px 6px 0px 0px rgba(0,0,0,0.15)',
                        'pop-banana': '4px 4px 0px 0px #ca8a04',
                        'pop-frog': '4px 4px 0px 0px #15803d',
                    }
                }
            }
        }
    </script>
    <style>
        /* --- å…¨å±€ä¸èƒŒæ™¯ --- */
        body {
            background-color: #f0fdf4;
            /* æ›´æœ‰è¶£çš„èƒŒæ™¯ï¼šç‚¹é˜µçº¹ç† + é²œè‰³å…‰æ™• */
            background-image:
                radial-gradient(#22c55e 1px, transparent 1px),
                radial-gradient(at 0% 0%, rgba(250, 204, 21, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(74, 222, 128, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 255, 255, 0.8) 0px, transparent 50%);
            background-size: 24px 24px, 100% 100%, 100% 100%, 100% 100%; /* ç‚¹é˜µå¤§å° */
            background-attachment: fixed;
            color: #1e293b;
            overflow: hidden;
            height: 100vh;
        }

        /* --- åº”ç”¨çª—å£æ ·å¼ - ç°ä»£æ³¢æ™®é£æ ¼ --- */
        #app-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            
            /* å¼ºçƒˆçš„æŠ•å½±å’Œè¾¹æ¡†ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
            box-shadow: 
                0 25px 50px -12px rgba(22, 101, 52, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.8) inset,
                0 0 0 4px rgba(255, 255, 255, 0.4); /* å¤–å‘å…‰è¾¹æ¡† */
            
            border-radius: 2rem;
            overflow: hidden;
            
            width: calc(100% - 1rem);
            height: calc(100% - 1rem);
            top: 0.5rem;
            left: 0.5rem;
            margin: auto;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* å¹³æ¿å’Œæ¡Œé¢ç«¯ */
        @media (min-width: 640px) {
            #app-container {
                width: calc(100% - 3rem);
                height: calc(100% - 3rem);
                top: 1.5rem;
                left: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            #app-container {
                width: calc(100% - 6rem);
                height: calc(100% - 6rem);
                top: 3rem;
                left: 3rem;
            }
        }

        /* å¤§å±å¹•é€‚é… */
        @media (min-width: 1536px) {
            #app-container {
                width: calc(100% - 8rem);
                height: calc(100% - 8rem);
                top: 4rem;
                left: 4rem;
            }
        }

        @media (min-width: 1920px) {
            #app-container {
                width: calc(100% - 10rem);
                height: calc(100% - 10rem);
                top: 5rem;
                left: 5rem;
            }
        }

        @media (min-width: 2560px) {
            #app-container {
                width: calc(100% - 12rem);
                height: calc(100% - 12rem);
                top: 6rem;
                left: 6rem;
            }
        }

        @media (min-width: 3840px) {
            #app-container {
                width: calc(100% - 16rem);
                height: calc(100% - 16rem);
                top: 8rem;
                left: 8rem;
            }
        }

        /* --- ä¾§è¾¹æ  - æ¸…æ–°è´¨æ„Ÿ --- */
        #ai-sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-left: 1px solid rgba(22, 163, 74, 0.1);
            box-shadow: -10px 0 40px rgba(22, 101, 52, 0.05);
            
            width: 100%;
            transform: translateX(0);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            flex-shrink: 0;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
        }

        @media (min-width: 640px) {
            #ai-sidebar {
                width: 380px;
                position: relative;
                z-index: auto;
            }
        }

        @media (min-width: 1024px) {
            #ai-sidebar {
                width: 420px;
            }
        }

        #ai-sidebar.collapsed {
            transform: translateX(100%);
            width: 0;
            padding: 0;
            margin: 0;
            opacity: 0;
            overflow: hidden;
        }
        #sidebar-content.hidden {
            display: none !important;
        }
        #main-stage {
            flex-grow: 1;
            transition: width 0.4s, flex-grow 0.4s;
            max-width: 100%;
            min-width: 0;
        }

        /* --- æ‚¬æµ®æœºå™¨äºº - Qå¼¹åŠ¨æ•ˆ --- */
        #floating-robot {
            background-color: #facc15; 
            border: 3px solid #ffffff;
            color: #14532d;
            /* å¼ºåŠ›é˜´å½± */
            box-shadow: 4px 4px 0px 0px #ca8a04, 0 10px 20px rgba(0,0,0,0.1);
            
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¼¹æ€§è´å¡å°”æ›²çº¿ */
            width: 3.5rem;
            height: 3.5rem;
        }

        @media (min-width: 640px) {
            #floating-robot {
                width: 5rem;
                height: 5rem;
            }
        }

        #floating-robot:hover {
            transform: scale(1.1) rotate(-12deg) translateY(-2px);
            box-shadow: 6px 6px 0px 0px #ca8a04, 0 15px 30px rgba(0,0,0,0.15);
            background-color: #fde047;
        }
        
        #floating-robot:active {
            transform: scale(0.95);
            box-shadow: 2px 2px 0px 0px #ca8a04;
        }

        /* --- æ–‡ä»¶å¡ç‰‡ - å¾®ç«‹ä½“é£æ ¼ --- */
        .glass-card {
            background: #ffffff;
            border: 2px solid rgba(241, 245, 249, 1);
            border-radius: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: #4ade80;
            /* ç»¿è‰²ç«‹ä½“é˜´å½± */
            box-shadow: 6px 6px 0px 0px #dcfce7;
        }
        
        .glass-card:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 2px 2px 0px 0px #dcfce7;
        }

        /* æ²™ç›’æ‹–æ‹½é«˜äº® - æ–‘é©¬çº¿æ•ˆæœ */
        #sandbox-grid-wrapper.drag-over {
            border: 3px dashed #22c55e;
            background-image: repeating-linear-gradient(
                45deg,
                rgba(220, 252, 231, 0.5),
                rgba(220, 252, 231, 0.5) 10px,
                rgba(240, 253, 244, 0.5) 10px,
                rgba(240, 253, 244, 0.5) 20px
            );
            border-radius: 1.5rem;
            transition: all 0.2s;
        }
        
        #chat-input-wrapper.drag-over-chat {
            border-color: #facc15;
            box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.4);
            transform: scale(1.01);
        }

        /* æ¨¡æ€æ¡†èƒŒæ™¯ */
        .modal-overlay {
            background: rgba(20, 83, 45, 0.2);
            backdrop-filter: blur(12px);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #22c55e;
        }

        /* --- å“åº”å¼ä¼˜åŒ– --- */
        @media (max-width: 639px) {
            .upload-btn-text { display: none; }
            header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 1rem;
            }
            header > div:last-child {
                width: 100%;
                justify-content: space-between;
            }
            .sandbox-file-card {
                height: auto;
                min-height: 8rem;
            }
            #modal-content-area {
                max-width: 100% !important;
                height: 100% !important;
                border-radius: 0 !important;
            }
            #ai-sidebar:not(.collapsed) { width: 100% !important; }
        }

        @media (max-width: 1023px) {
            #main-stage { padding: 1rem; }
        }

        @media (max-width: 639px) {
            h1 { font-size: 1.25rem; }
            .text-2xl { font-size: 1.25rem; }
        }

        /* å¤§å±å¹•ï¼šæ–‡ä»¶ç½‘æ ¼æ˜¾ç¤ºæ›´å¤šåˆ— */
        @media (min-width: 1536px) {
            #file-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        }

        @media (min-width: 1920px) {
            #file-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        }

        @media (min-width: 2560px) {
            #file-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        }
    </style>
</head>
<body class="flex overflow-hidden relative">

    <button id="floating-robot" onclick="toggleWorkspace(true)"
            class="fixed bottom-4 right-4 sm:bottom-10 sm:right-10 z-[100] w-14 h-14 sm:w-20 sm:h-20 rounded-full flex items-center justify-center hidden">
        <i class="fa-solid fa-robot text-2xl sm:text-4xl text-frog-900"></i>
    </button>

    <div id="app-container" class="fixed opacity-100 transform scale-[1] transition-all duration-500">

        <div class="flex h-full w-full">

            <main class="relative p-4 sm:p-6 md:p-8 lg:p-12 flex flex-col h-full overflow-y-auto" id="main-stage">

                <div class="flex flex-col max-w-7xl mx-auto w-full h-full">
                    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-6 sm:mb-8 md:mb-10 pb-4 border-b border-slate-200 flex-shrink-0 gap-4 sm:gap-0">
                        <div>
                            <h1 class="text-xl sm:text-2xl font-bold tracking-tight text-frog-900 flex items-center gap-2">
                                <i class="fa-solid fa-frog text-frog-500 animate-bounce"></i> è•‰ç»¿è›™ AI <span class="text-slate-400 font-normal text-lg">Pro</span>
                            </h1>
                            <p class="text-slate-500 text-xs sm:text-sm font-medium">æ‚¨çš„æ™ºèƒ½å·¥ä½œä¼™ä¼´ / æ–‡ä»¶ç®¡ç†</p>
                        </div>

                        <div class="flex gap-2 sm:gap-3 flex-wrap">
                            <button onclick="fetchFiles()" class="w-10 h-10 rounded-xl bg-white border-2 border-slate-100 hover:border-frog-400 hover:text-frog-600 text-slate-400 flex items-center justify-center transition shadow-pop hover:shadow-pop-hover active:translate-y-1 active:shadow-none" title="åˆ·æ–°æ–‡ä»¶åˆ—è¡¨">
                                <i class="fa-solid fa-sync-alt"></i>
                            </button>
                            <button onclick="document.getElementById('global-upload').click()" class="px-3 sm:px-4 py-2 rounded-xl bg-banana-400 border-2 border-banana-500 hover:bg-banana-300 text-frog-900 text-sm font-bold shadow-pop-banana transition flex items-center gap-2 active:translate-y-1 active:shadow-none">
                                <i class="fa-solid fa-cloud-arrow-up"></i> <span class="upload-btn-text">ä¸Šä¼ æ–‡ä»¶</span>
                            </button>
                            <input type="file" id="global-upload" hidden multiple onchange="handleFileUpload(event)"/>
                            <button onclick="toggleWorkspace(false)" class="w-10 h-10 rounded-xl bg-white border-2 border-slate-100 hover:bg-red-50 hover:border-red-200 hover:text-red-500 text-slate-400 flex items-center justify-center transition shadow-pop hover:shadow-pop-hover active:translate-y-1 active:shadow-none" title="æ”¶èµ·åº”ç”¨">
                                <i class="fa-solid fa-power-off"></i>
                            </button>
                        </div>
                    </header>

                    <div id="sandbox-grid-wrapper" class="flex-1 overflow-y-auto pr-1 sm:pr-2 pb-6 sm:pb-10">
                        <div id="file-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
                            <div class="col-span-full text-center text-slate-400 mt-10" id="empty-state">
                                <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-frog-50 text-frog-400 mb-6 border-2 border-frog-100 shadow-pop-frog">
                                    <i class="fa-solid fa-cloud-upload-alt text-4xl"></i>
                                </div>
                                <p class="text-xl font-bold text-slate-700">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ</p>
                                <p class="text-sm mt-2 text-slate-500">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®ä¸Šä¼ ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="wake-btn" onclick="toggleSidebar()" class="fixed sm:absolute bottom-4 right-4 sm:bottom-8 sm:right-8 z-30 group transition-all duration-300 hover:scale-110 active:scale-95 hidden">
                    <div class="relative w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-banana-400 border-2 border-white text-frog-900 flex items-center justify-center shadow-xl shadow-banana-shadow">
                        <i class="fa-solid fa-comment-dots text-lg sm:text-xl"></i>
                    </div>
                </button>
            </main>

            <aside id="ai-sidebar" class="h-full flex flex-col shadow-2xl relative z-50">
                <div id="sidebar-content" class="flex flex-col h-full opacity-100 transition-opacity duration-300">
                    <div class="h-14 sm:h-16 flex items-center justify-between px-4 sm:px-6 border-b border-slate-100 flex-shrink-0 bg-white/50 backdrop-blur-md">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-frog-500 animate-pulse border border-frog-600"></span>
                            <h2 class="text-sm sm:text-base font-bold text-slate-700 tracking-wide">AI åŠ©æ‰‹</h2>
                        </div>
                        <button onclick="toggleSidebar()" class="w-8 h-8 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 flex items-center justify-center transition" title="æ”¶èµ·é¢æ¿">
                            <i class="fa-solid fa-arrow-right-to-bracket"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6 sm:space-y-8 scroll-smooth" id="chat-container">
                        <div class="flex gap-4">
                            <div class="w-10 h-10 rounded-xl bg-frog-100 text-frog-600 flex items-center justify-center flex-shrink-0 text-xs font-bold border-2 border-frog-200 mt-1 shadow-pop-frog">AI</div>
                            <div class="bubble-ai p-4 rounded-2xl rounded-tl-none bg-white text-slate-700 text-sm leading-relaxed shadow-sm border-2 border-slate-100">
                                <p>æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„<span class="font-bold text-frog-600">è•‰ç»¿è›™</span>æ™ºèƒ½åŠ©æ‰‹ ğŸ¸ã€‚è¯·ä¸Šä¼ æ–‡ä»¶æˆ–ç›´æ¥ä¸æˆ‘å¯¹è¯ï¼</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 sm:p-4 md:p-5 input-area relative flex-shrink-0">
                        <div id="chat-input-wrapper" class="relative group">
                            <textarea
                                id="chat-input"
                                class="w-full bg-white text-slate-800 text-sm p-3 sm:p-4 pr-12 sm:pr-14 rounded-2xl border-2 border-slate-200 focus:border-frog-400 focus:ring-0 focus:outline-none resize-none placeholder-slate-400 transition-all shadow-sm h-12 sm:h-14 max-h-40 overflow-y-auto"
                                placeholder="æƒ³èŠç‚¹ä»€ä¹ˆï¼Ÿæˆ–æ‹–å…¥æ–‡ä»¶..."
                                rows="1"
                                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                            ></textarea>

                            <div class="absolute bottom-2 sm:bottom-2.5 right-2 flex items-center gap-1">
                                <button class="p-1.5 sm:p-2 bg-frog-500 hover:bg-frog-400 text-white rounded-xl transition shadow-pop-frog transform active:translate-y-0.5 active:shadow-none border-2 border-frog-600" onclick="sendMessage()">
                                    <i class="fa-solid fa-paper-plane text-xs sm:text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-center mt-1 sm:mt-2">
                            <p class="text-[9px] sm:text-[10px] text-slate-400">AI æ¨¡å‹å¯èƒ½ç”Ÿæˆä¸å‡†ç¡®çš„ä¿¡æ¯ï¼Œè¯·ä»”ç»†æ ¸å¯¹ã€‚</p>
                        </div>
                    </div>
                </div>
            </aside>

        </div>
    </div>

    <div id="file-viewer-modal" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay" onclick="closeFileViewer(event)">
        <div id="modal-content-area" class="modal-content bg-white rounded-none sm:rounded-3xl shadow-2xl w-full h-full sm:h-5/6 sm:max-w-4xl flex flex-col transform scale-95 opacity-0 transition-all duration-300 overflow-hidden border-4 border-white">
            <div class="p-3 sm:p-4 border-b border-slate-100 flex justify-between items-center flex-shrink-0 bg-slate-50">
                <h3 id="file-viewer-title" class="text-base sm:text-lg font-bold text-slate-800 truncate pr-2 flex items-center gap-2">
                    <i class="fa-solid fa-file-alt text-frog-500"></i>
                    <span>æ–‡ä»¶é¢„è§ˆ</span>
                </h3>
                <button onclick="closeFileViewer()" class="text-slate-400 hover:text-red-500 w-8 h-8 rounded-full hover:bg-red-50 transition flex-shrink-0 flex items-center justify-center">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="flex-1 p-3 sm:p-4 md:p-6 overflow-y-auto text-slate-600 text-xs sm:text-sm bg-white">
                <div class="bg-slate-50 p-3 sm:p-4 md:p-6 rounded-xl h-full border-2 border-slate-100 font-mono">
                    <p class="text-[10px] sm:text-xs text-frog-600 mb-3 sm:mb-4 font-bold">// æ–‡ä»¶å†…å®¹ (<span id="file-name-content"></span>)</p>
                    <pre class="whitespace-pre-wrap text-slate-700 leading-relaxed text-xs sm:text-sm" id="file-content-display">
                        æ­£åœ¨åŠ è½½æ–‡ä»¶å†…å®¹...
                    </pre>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-3 right-3 sm:top-5 sm:right-5 z-[110] space-y-2 max-w-[calc(100%-1.5rem)] sm:max-w-none"></div>


    <script>
        const API_BASE = 'http://localhost:5000'; // åç«¯æœåŠ¡åœ°å€
        const sidebar = document.getElementById('ai-sidebar');
        const sidebarContent = document.getElementById('sidebar-content');
        const mainStage = document.getElementById('main-stage');
        const wakeBtn = document.getElementById('wake-btn');
        const inputWrapper = document.getElementById('chat-input-wrapper');
        const appContainer = document.getElementById('app-container');
        const floatingRobot = document.getElementById('floating-robot');
        const fileGrid = document.getElementById('file-grid');
        const sandboxWrapper = document.getElementById('sandbox-grid-wrapper');
        const fileViewerModal = document.getElementById('file-viewer-modal');
        const modalContent = document.getElementById('modal-content-area');


        // --- 0. é€šçŸ¥/æ¶ˆæ¯æç¤º (ä»£æ›¿ alert) ---
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            let color = 'bg-frog-500 border-2 border-frog-600 shadow-pop-frog';
            let icon = '<i class="fa-solid fa-info-circle mr-2"></i>';
            
            if (type === 'error') {
                color = 'bg-red-500 border-2 border-red-600 shadow-pop';
                icon = '<i class="fa-solid fa-exclamation-circle mr-2"></i>';
            }
            if (type === 'success') {
                color = 'bg-frog-500 border-2 border-frog-600 shadow-pop-frog';
                icon = '<i class="fa-solid fa-check-circle mr-2"></i>';
            }

            toast.className = `p-3 sm:p-4 rounded-xl text-white ${color} transition-all duration-300 transform translate-x-full opacity-0 text-sm sm:text-base max-w-[calc(100vw-1.5rem)] sm:max-w-sm flex items-center`;
            toast.innerHTML = `${icon}<span class="font-medium">${message}</span>`;
            document.getElementById('toast-container').appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- 1. çª—å£å’Œä¾§è¾¹æ æ§åˆ¶ ---

        function toggleWorkspace(isOpen) {
            if (isOpen) return;

            appContainer.classList.add('opacity-0', 'scale-[0.5]');
            setTimeout(() => {
                appContainer.classList.add('hidden');
            }, 500);
        }

        function toggleSidebar(forceOpen = false) {
            const isCollapsed = sidebar.classList.contains('collapsed');
            const isMobile = window.innerWidth < 640;

            if (isCollapsed || forceOpen) {
                sidebar.classList.remove('collapsed');
                if (isMobile) {
                    // ç§»åŠ¨ç«¯ï¼šä¾§è¾¹æ æ‰“å¼€æ—¶é˜»æ­¢ä¸»å†…å®¹æ»šåŠ¨
                    document.body.style.overflow = 'hidden';
                    // æ·»åŠ é®ç½©å±‚
                    if (!document.getElementById('sidebar-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.id = 'sidebar-overlay';
                        overlay.className = 'fixed inset-0 bg-black/50 z-40 sm:hidden';
                        overlay.onclick = () => toggleSidebar();
                        document.body.appendChild(overlay);
                    }
                }
                setTimeout(() => {
                    sidebarContent.classList.remove('hidden');
                }, isMobile ? 10 : 400);
                wakeBtn.classList.add('hidden');
            } else {
                sidebarContent.classList.add('hidden');
                if (isMobile) {
                    // ç§»åŠ¨ç«¯ï¼šä¾§è¾¹æ å…³é—­æ—¶æ¢å¤æ»šåŠ¨
                    document.body.style.overflow = '';
                    // ç§»é™¤é®ç½©å±‚
                    const overlay = document.getElementById('sidebar-overlay');
                    if (overlay) overlay.remove();
                }
                setTimeout(() => {
                    sidebar.classList.add('collapsed');
                }, 10);
                wakeBtn.classList.remove('hidden');
            }
        }

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´ä¾§è¾¹æ è¡Œä¸º
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const isMobile = window.innerWidth < 640;
                if (!isMobile && sidebar.classList.contains('collapsed')) {
                    // ä»ç§»åŠ¨ç«¯åˆ‡æ¢åˆ°æ¡Œé¢ç«¯æ—¶ï¼Œæ¢å¤æ»šåŠ¨
                    document.body.style.overflow = '';
                }
            }, 250);
        });

        // --- 2. æ–‡ä»¶ä¸Šä¼ é€»è¾‘ (ä¸åç«¯äº¤äº’) ---

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸï¼`, 'success');
                    fetchFiles(); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    return true;
                } else {
                    showToast(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥: ${result.error || 'æœåŠ¡å™¨é”™è¯¯'}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Upload error:', error);
                showToast(`ç½‘ç»œé”™è¯¯æˆ–åç«¯æœªè¿è¡Œï¼Œæ— æ³•ä¸Šä¼ æ–‡ä»¶ ${file.name}`, 'error');
                return false;
            }
        }

        async function handleFileUpload(e) {
            const files = e.target.files;
            if (files.length > 0) {
                for (const file of files) {
                    await uploadFile(file);
                }
            }
            e.target.value = '';
        }

        // --- 3. æ‹–æ‹½ä¸Šä¼ å¤„ç† (Sandbox & Chat) ---

        function preventDefaults (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e, target) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                if (target === 'sandbox') {
                    for (const file of files) {
                        uploadFile(file);
                    }
                } else if (target === 'chat') {
                    const fileNames = Array.from(files).map(f => f.name).join(', ');
                    showToast(`æ–‡ä»¶ ${fileNames} å·²é™„åŠ åˆ°æ¶ˆæ¯ã€‚ï¼ˆAIé™„ä»¶åŠŸèƒ½å¾…å®ç°ï¼‰`, 'info');
                    // å®é™…åº”ç”¨ä¸­ï¼šå°†æ–‡ä»¶å¯¹è±¡å­˜å‚¨ä¸ºæ¶ˆæ¯é™„ä»¶
                }
            }
        }

        // Sandbox Drag Logic
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            sandboxWrapper.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            sandboxWrapper.addEventListener(eventName, () => sandboxWrapper.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            sandboxWrapper.addEventListener(eventName, () => sandboxWrapper.classList.remove('drag-over'), false);
        });

        sandboxWrapper.addEventListener('drop', (e) => handleDrop(e, 'sandbox'), false);

        // Chat Drag Logic
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, () => inputWrapper.classList.add('drag-over-chat'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, () => inputWrapper.classList.remove('drag-over-chat'), false);
        });

        inputWrapper.addEventListener('drop', (e) => handleDrop(e, 'chat'), false);

        // --- 4. æ–‡ä»¶åˆ—è¡¨ä¸æŸ¥çœ‹ ---

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['pdf', 'doc', 'docx'].includes(ext)) return 'fa-regular fa-file-pdf text-red-400';
            if (['png', 'jpg', 'jpeg', 'gif'].includes(ext)) return 'fa-regular fa-image text-purple-400';
            if (['py', 'js', 'html', 'css', 'json', 'md', 'csv', 'xml'].includes(ext)) return 'fa-solid fa-code text-blue-400';
            if (['txt', 'log'].includes(ext)) return 'fa-regular fa-file-alt text-slate-400';
            return 'fa-regular fa-file text-gray-400';
        }

        function createCard(filename) {
            const iconClass = getFileIcon(filename);
            return `
                <div class="glass-card sandbox-file-card p-4 sm:p-5 rounded-xl sm:rounded-2xl h-auto min-h-[10rem] sm:h-48 flex flex-col justify-between group cursor-pointer hover:shadow-pop-hover transition transform hover:-translate-y-1" onclick="openFileViewer('${filename}')">
                    <div class="flex justify-between items-start">
                        <div class="w-10 h-10 rounded-xl bg-slate-50 text-lg sm:text-xl flex items-center justify-center border-2 border-slate-100 group-hover:bg-white group-hover:border-frog-200 transition-colors">
                            <i class="${iconClass}"></i>
                        </div>
                        <button class="text-slate-400 hover:text-frog-500 transition"><i class="fa-solid fa-ellipsis text-sm"></i></button>
                    </div>
                    <div>
                        <h3 class="text-sm sm:text-base font-bold text-slate-700 group-hover:text-frog-700 truncate transition-colors">${filename}</h3>
                        <div class="flex items-center justify-between mt-2 sm:mt-3">
                            <span class="text-[10px] sm:text-xs text-slate-400 font-mono">... KB</span>
                            <span class="text-[10px] sm:text-xs text-frog-600 bg-frog-50 px-2 py-0.5 rounded-full font-bold border border-frog-100">å·²ä¸Šä¼ </span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function fetchFiles() {
            try {
                const response = await fetch(`${API_BASE}/files`);

                if (response.ok) {
                    const result = await response.json();
                    const files = result.files || [];
                    fileGrid.innerHTML = files.map(createCard).join('');
                    document.getElementById('empty-state').style.display = files.length === 0 ? 'block' : 'none';
                } else {
                    // å¦‚æœçŠ¶æ€ç ä¸æ˜¯ 200ï¼Œå°è¯•è·å–é”™è¯¯ä¿¡æ¯
                    const errorText = await response.text();
                    console.error('Fetch Files Failed (Non-200 Status):', response.status, errorText);
                    fileGrid.innerHTML = `<p class="col-span-full text-red-400 mt-10">è¿æ¥æˆåŠŸï¼Œä½†åç«¯è¿”å›é”™è¯¯çŠ¶æ€ç  (${response.status})ã€‚</p>`;
                    document.getElementById('empty-state').style.display = 'none';
                }
            } catch (error) {
                // ç½‘ç»œé”™è¯¯æˆ– JSON è§£æé”™è¯¯ä¼šè¿›å…¥è¿™é‡Œ
                console.error('Fetch Files Network/Parse Error:', error);
                fileGrid.innerHTML = `<p class="col-span-full text-red-400 mt-10">ç½‘ç»œé”™è¯¯: åç«¯æœåŠ¡æœªè¿è¡Œæˆ–åœ°å€é”™è¯¯ã€‚</p>`;
                document.getElementById('empty-state').style.display = 'none';
            }
        }

        // æ–‡ä»¶æŸ¥çœ‹å™¨
        async function openFileViewer(fileName) {
            document.getElementById('file-viewer-title').textContent = `${fileName} - é¢„è§ˆ`;
            document.getElementById('file-name-content').textContent = fileName;
            document.getElementById('file-content-display').textContent = "æ­£åœ¨ä»æœåŠ¡å™¨åŠ è½½æ–‡ä»¶å†…å®¹...";

            fileViewerModal.classList.remove('hidden');
            setTimeout(() => {
                fileViewerModal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);

            try {
                const response = await fetch(`${API_BASE}/file/${fileName}`);
                if (response.ok) {
                    const content = await response.text();
                    document.getElementById('file-content-display').textContent = content;
                } else {
                    const errorText = await response.text();
                    document.getElementById('file-content-display').textContent = `æ— æ³•åŠ è½½æ–‡ä»¶å†…å®¹ï¼š${errorText}`;
                    console.error('View File Error:', response.status, errorText);
                }
            } catch (error) {
                document.getElementById('file-content-display').textContent = 'ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ä»¥è·å–æ–‡ä»¶å†…å®¹ã€‚';
                console.error('View File Network Error:', error);
            }
        }

        function closeFileViewer(e) {
            if (e && e.target.id !== 'file-viewer-modal') return;

            fileViewerModal.classList.remove('opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                fileViewerModal.classList.add('hidden');
            }, 300);
        }

        // èŠå¤©åŠŸèƒ½ï¼ˆä»…æ¨¡æ‹Ÿï¼‰
        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            if (!message) return;

            appendMessage(message, 'user');

            // æ£€æŸ¥å¹¶æ¸…ç©ºè¾“å…¥æ¡†
            chatInput.value = '';
            chatInput.style.height = 'auto'; // é‡ç½®é«˜åº¦

            scrollToChatBottom();

            // æ¨¡æ‹Ÿ AI å›å¤
            setTimeout(() => {
                appendMessage("æŠ±æ­‰ï¼Œç›®å‰ AI èŠå¤©åŠŸèƒ½å°šæœªè¿æ¥åˆ°å®é™…çš„è¯­è¨€æ¨¡å‹ APIã€‚", 'ai');
                scrollToChatBottom();
            }, 500);
        }

        function appendMessage(text, sender) {
            const chatContainer = document.getElementById('chat-container');
            const isAI = sender === 'ai';
            const icon = isAI
                ? '<div class="w-10 h-10 rounded-xl bg-frog-100 text-frog-600 flex items-center justify-center flex-shrink-0 text-xs font-bold border-2 border-frog-200 mt-1 shadow-pop-frog">AI</div>'
                : '<div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center flex-shrink-0 text-xs font-bold border-2 border-slate-200 mt-1 shadow-sm">Me</div>';
            const bubbleClass = isAI ? 'bubble-ai bg-white text-slate-700 border-2 border-slate-100 rounded-tl-none' : 'bubble-user bg-frog-500 text-white border-2 border-frog-600 rounded-tr-none shadow-pop-frog';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-4 ${isAI ? '' : 'flex-row-reverse'}`;
            messageDiv.innerHTML = `
                ${icon}
                <div class="${bubbleClass} p-4 rounded-2xl text-sm leading-relaxed shadow-sm max-w-[80%] whitespace-pre-wrap">
                    ${text}
                </div>
            `;
            chatContainer.appendChild(messageDiv);
        }

        function scrollToChatBottom() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ–‡æœ¬åŸŸé«˜åº¦è‡ªé€‚åº”
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            function adjustHeight() {
                chatInput.style.height = 'auto';
                chatInput.style.height = chatInput.scrollHeight + 'px';
            }
            chatInput.addEventListener('input', adjustHeight);

            // åˆå§‹åŒ–ï¼šåŠ è½½æ–‡ä»¶åˆ—è¡¨
            fetchFiles();
        });
    </script>
</body>
</html>