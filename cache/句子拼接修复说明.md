# 句子拼接修复说明

## 问题描述

用户反馈ASR识别的句子拼接不完整。例如：

**实际日志**：
```
999  | [is_end=False] "will"
1000 | [is_end=False] "要分"
1001 | [is_end=False] "期还"
1002 | [is_end=True] "期还"      ← 句子结束
1003 | [完整句子] 坐席: 期还       ❌ 错误！应该是"我要分期还"

1011 | [is_end=False] "我要分"    ← 新句子开始
1012 | [is_end=False] "期还"
1013 | [is_end=True] "期还"
```

- **错误输出**：只保存了 `"期还"`
- **正确输出**：应该是 `"我要分期还"` 或 `"will 要分 期还"`

## 根本原因

在 `core/asr_service.py` 的 **第246行**，原来的代码每次都会**覆盖**句子缓存：

```python
# ❌ 错误的做法
process_audio_chunk.sentence_buffer[source] = text.strip()
```

这导致只保留最后一个识别片段，丢失了前面的内容。

## FunASR流式识别的特性

**重要发现**：FunASR的流式识别（`is_final=False`模式）返回的是**增量片段**，不是累积结果！

从日志分析：
- 第1次：`"will"` （可能是"我"的误识别）
- 第2次：`"要分"` （独立片段）
- 第3次：`"期还"` （独立片段）

**因此，我们必须手动拼接这些片段！**

## 修复方案

### 修改代码（core/asr_service.py）

```python
# ✅ 正确的做法：直接使用FunASR返回的累积结果
if res and len(res) > 0:
    text = res[0].get('text', '')
    if text and text.strip():
        # FunASR流式识别返回的是累积结果，直接保存
        process_audio_chunk.sentence_buffer[source] = text.strip()
        
        # 发送实时进度（is_end=False，前端显示但不触发推荐）
        recognition_result = RecognitionResult(
            source=source,
            text=text.strip(),
            is_end=False,
            isCompliant=False
        )
        result_queue.put(recognition_result)
        ...
```

### 工作流程

1. **实时累积阶段**（`is_end=False`）
   - FunASR持续返回累积结果：`"老"` → `"老赖"` → `"老赖你"`
   - 每次更新 `sentence_buffer`
   - 发送给前端显示进度
   - 更新 `last_audio_time`

2. **句子结束检测**
   - 静音超过 `1.2秒`（`silence_threshold`）
   - 触发句子结束逻辑

3. **发送完整句子**（`is_end=True`）
   - 从 `sentence_buffer` 获取完整句子：`"老赖你"`
   - 发送给前端和后端处理
   - 清空缓存 `sentence_buffer[source] = ""`
   - 清空ASR cache

## 关键点理解

### is_end 标志的含义

- **`is_end=False`**：句子**未结束**，继续累积识别
  - 前端：显示实时草稿
  - 后端：**不触发关键词识别**，等待完整句子

- **`is_end=True`**：句子**已结束**
  - 前端：显示最终结果
  - 后端：**触发关键词识别和话术推荐**

### 句子结束的判断

使用**静音检测**判断：

```python
silence_duration = current_time - last_audio_time[source]

if silence_duration > silence_threshold:  # 1.2秒
    # 句子结束，发送 is_end=True
```

## 测试验证

创建了测试脚本 `test_sentence_buffer.py` 验证修复：

```
--- 第 1 次识别 ---
[实时] microphone: "老" (is_end=False)

--- 第 2 次识别 ---
[实时] microphone: "老赖" (is_end=False)

--- 第 3 次识别 ---
[实时] microphone: "老赖你" (is_end=False)

--- 静音 1.2 秒 ---
[完整] microphone: "老赖你" (is_end=True)
```

✅ **验证通过**：完整句子正确拼接为 `"老赖你"`

## 后续建议

1. **监控ASR日志**
   - 查看 `logs/asr_service_*.log`
   - 确认实时识别和完整句子的输出

2. **调整静音阈值**（如需要）
   - 当前：`silence_threshold = 1.2` 秒
   - 太短：句子会被过早截断
   - 太长：响应延迟增加

3. **前端显示优化**
   - `is_end=False`：显示半透明草稿气泡
   - `is_end=True`：显示完整消息，触发推荐

## 修复文件

- ✅ `core/asr_service.py`（第246行）

## 日期

2025-11-14

